<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="å®‡ä¸œæŠ¥ä»·">
    <title>å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿ - Cloudflare R2äº‘ç«¯ç‰ˆ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- AWS S3 SDK (å…¼å®¹Cloudflare R2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1462.0/aws-sdk.min.js"></script>

    <style>
        /* ZA Bank é£æ ¼å˜é‡ */
        :root {
            --za-green-light: #52D1B2;
            --za-green-dark: #40A891;
            --za-gradient: linear-gradient(135deg, var(--za-green-light) 0%, var(--za-green-dark) 100%);
            --za-bg: #f0f2f5;
            --za-surface: #ffffff;
            --za-text: #1F2937;
            --za-text-secondary: #6B7280;
            --za-radius-lg: 20px;
            --za-radius-md: 12px;
            --za-radius-sm: 8px;
            --za-shadow: 0 4px 8px rgba(0, 0, 0, 0.05), 0 10px 20px rgba(0, 0, 0, 0.03);
            --za-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);

            --success: #34C759;
            --error: #FF3B30;
            --warning: #FF9500;
            --spacing: 1.25rem;
            --transition: all 0.2s ease;
        }

        /* åŸºç¡€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background: var(--za-bg);
            min-height: 100vh;
            color: var(--za-text);
            padding: 0; 
            display: flex;
            justify-content: center;
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
            /* é˜²æ­¢é‡ç»˜é—®é¢˜ */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            /* ä¼˜åŒ–æ¸²æŸ“ */
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeSpeed;
        }

        .container {
            width: 100%;
            max-width: 800px; 
            margin: 0 auto;
            padding: 0;
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* ä¼˜åŒ–æ¸²æŸ“ */
            will-change: transform;
            overflow-x: hidden;
        }

        /* é¡¶éƒ¨ Header å’Œ Stats åŒºåŸŸ */
        .header-section {
            background: var(--za-gradient);
            padding: 2rem var(--spacing);
            border-bottom-left-radius: var(--za-radius-lg);
            border-bottom-right-radius: var(--za-radius-lg);
            box-shadow: var(--za-shadow);
            color: white;
            margin-bottom: var(--spacing);
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ¸²æŸ“é—®é¢˜ */
            position: relative;
            z-index: 10;
            /* ä¼˜åŒ–æ¸²æŸ“ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.25rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .app-subtitle {
            font-size: 0.875rem;
            text-align: center;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(8px);
            padding: 0.75rem 0.25rem;
            border-radius: var(--za-radius-md);
            text-align: center;
            transition: var(--transition);
            overflow: hidden; 
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
            color: white; 
        }

        .stat-label {
            font-size: 0.65rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.2;
        }

        /* å­˜å‚¨çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .storage-status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--za-radius-sm);
            font-size: 0.7rem;
        }

        .storage-status-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .storage-status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .storage-local {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }

        .storage-r2 {
            background: rgba(82, 209, 178, 0.2);
            color: #52D1B2;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆªæ  */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            background: var(--za-surface);
            border-radius: var(--za-radius-lg);
            margin: 0 var(--spacing);
            box-shadow: var(--za-shadow-sm);
            padding: 0.5rem;
            margin-bottom: var(--spacing);
            overflow: hidden; 
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ¸²æŸ“é—®é¢˜ */
            position: relative;
            z-index: 10;
            /* ä¼˜åŒ–æ¸²æŸ“ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            border: none;
            background: transparent;
            color: var(--za-text-secondary);
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--za-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
        }

        .tab-button.active {
            background: var(--za-gradient);
            color: white;
            box-shadow: var(--za-shadow-sm);
            transform: translateY(-1px);
        }

        .tab-button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        .tab-button.active:active {
            transform: translateY(-1px) scale(0.95);
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            padding: 0 var(--spacing) var(--spacing) var(--spacing); 
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* ä¼˜åŒ–æ¸²æŸ“ */
            will-change: transform;
        }

        .tab-content {
            display: none;
            background: var(--za-surface);
            padding: var(--spacing);
            border-radius: var(--za-radius-lg);
            box-shadow: var(--za-shadow);
            overflow: hidden; 
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ¸²æŸ“é—®é¢˜ */
            position: relative;
            z-index: 1;
            /* ä¼˜åŒ–æ¸²æŸ“ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ¨¡å—æ ‡é¢˜ */
        .module-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--za-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }

        /* é€šç”¨è¾“å…¥æ¡†å’ŒæŒ‰é’®æ ·å¼ */
        .search-input, .manage-input, .manage-search, .manage-file-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--za-radius-sm);
            font-size: 1rem;
            color: var(--za-text);
            background: #fafafa;
            transition: var(--transition);
            font-family: inherit;
        }

        .search-input {
            min-height: 5rem;
            resize: vertical;
            padding: 0.75rem 0.75rem 0.75rem 3rem; 
        }

        .search-input:focus, .manage-input:focus, .manage-search:focus {
            outline: none;
            border-color: var(--za-green-light);
            box-shadow: 0 0 0 3px rgba(82, 209, 178, 0.2); 
        }

        .search-box {
            position: relative;
            margin-bottom: var(--spacing);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 0.875rem;
            width: 1.25rem;
            height: 1.25rem;
            color: var(--za-text-secondary);
            pointer-events: none; 
        }
        
        /* å†å²è®°å½•/æ ‡ç­¾æ ·å¼ */
        .search-history {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        .history-item {
            padding: 0.5rem 1rem;
            background: #f0f0f0;
            border-radius: var(--za-radius-sm);
            font-size: 0.875rem;
            color: var(--za-text);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            overflow: hidden; 
        }

        .history-item:hover {
            background: var(--za-green-light);
            color: white;
        }

        .hint-text {
            background: #f0f9f8;
            padding: 0.75rem;
            border-radius: var(--za-radius-sm);
            color: var(--za-text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .hint-text::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--za-green-light);
            border-top-left-radius: var(--za-radius-sm);
            border-bottom-left-radius: var(--za-radius-sm);
        }

        /* çº¢è‰²æç¤ºæ¡† */
        .hint-text.hint-error {
            background: #FDE8E8;
            color: color-mix(in srgb, var(--error) 80%, black);
        }

        .hint-text.hint-error::before {
            background-color: var(--error);
        }

        /* æŒ‰é’®ç»„ */
        .button-row {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .za-btn {
            padding: 0.875rem 1.5rem;
            border-radius: var(--za-radius-md);
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            flex-grow: 1;
            min-width: 120px;
            box-shadow: var(--za-shadow-sm);
            /* é˜²æ­¢ç§»åŠ¨ç«¯ç‚¹å‡»é—ªçƒ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .za-btn:active {
            transform: translateY(1px);
        }

        .za-btn-primary {
            background: var(--za-gradient);
            color: white;
        }

        .za-btn-secondary {
            background: #f0f0f0;
            color: var(--za-text);
        }

        .za-btn-success { background: var(--success); color: white; }
        .za-btn-error { background: var(--error); color: white; }
        .za-btn-warning { background: var(--warning); color: white; }

        /* äº§å“å¡ç‰‡æ ·å¼ (æŸ¥è¯¢ç»“æœ) */
        .product-card {
            background: var(--za-surface);
            border: 1px solid #e5e7eb;
            border-radius: var(--za-radius-md);
            margin-bottom: var(--spacing);
            box-shadow: var(--za-shadow-sm);
            transition: var(--transition);
            overflow: hidden; 
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ¸²æŸ“é—®é¢˜ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* ä¼˜åŒ–æ¸²æŸ“ */
            will-change: transform;
        }

        .product-card:hover {
            box-shadow: var(--za-shadow);
        }

        .product-header {
            background: linear-gradient(90deg, #f0f9f8, var(--za-surface));
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--za-green-dark);
        }

        .match-badge {
            font-size: 0.75rem;
            background: var(--za-green-light);
            color: white;
            padding: 0.3em 0.7em;
            border-radius: var(--za-radius-md);
            font-weight: 600;
        }

        .product-content {
            padding: 1rem;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin-bottom: 1rem;
        }

        .spec-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--za-text-secondary);
            margin-bottom: 0.2rem;
            font-weight: 500;
        }

        .spec-item .value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--za-text);
        }
        
        .spec-item .value-normal {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--za-text);
        }
        
        /* ä¾›åº”å•†å’Œå›¾ç‰‡é“¾æ¥ */
        .supplier-box {
            padding: 0.75rem;
            border-radius: var(--za-radius-sm);
            background: #f8f8f8;
            display: flex;
            align-items: center;
            gap: 1rem; 
            flex-wrap: wrap; 
            overflow: hidden; 
        }
        
        .supplier-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--za-text-secondary);
        }
        
        .supplier-details {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap; 
        }
        
        .supplier-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--za-text);
            word-break: break-all; 
        }

        .view-image-link {
            font-size: 0.875rem;
            color: var(--za-green-dark);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }

        /* äº§å“ç®¡ç†è¡¨å• */
        .manage-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .manage-input-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--za-text-secondary);
            display: block;
        }

        .manage-btn-row {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        /* ========== ä¼˜åŒ–åçš„äº§å“ç®¡ç†å¡ç‰‡æ ·å¼ ========== */
        .manage-product-card {
            background: var(--za-surface);
            border: 1px solid #e5e7eb;
            border-radius: var(--za-radius-md);
            margin-bottom: var(--spacing);
            box-shadow: var(--za-shadow-sm);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* æ·»åŠ å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢å¸ƒå±€æŠ–åŠ¨ */
            min-height: 180px;
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ¸²æŸ“é—®é¢˜ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            will-change: transform;
            /* ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ */
            contain: layout style paint;
        }

        .manage-product-card:hover {
            box-shadow: var(--za-shadow);
        }

        .manage-product-header {
            background: linear-gradient(90deg, #f0f9f8, var(--za-surface));
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manage-product-code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--za-green-dark);
        }

        .manage-product-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            /* é˜²æ­¢å†…å®¹æº¢å‡ºå¯¼è‡´å¸ƒå±€é—®é¢˜ */
            overflow: hidden;
        }

        .manage-specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            flex: 1;
        }

        .manage-spec-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0.5rem;
        }

        .manage-spec-item label {
            font-size: 0.75rem;
            color: var(--za-text-secondary);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .manage-spec-item .value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--za-text);
            word-break: break-word;
        }

        .manage-product-full-row {
            grid-column: 1 / -1;
            text-align: center;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-top: 1px dashed #e0e0e0;
            padding-top: 0.75rem;
        }

        .manage-product-full-row label {
            font-size: 0.75rem;
            color: var(--za-text-secondary);
            margin-bottom: 0.25rem;
            font-weight: 500;
            display: block;
        }

        .manage-product-full-row .value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--za-text);
            word-break: break-word;
        }

        .manage-product-notes {
            font-size: 0.875rem;
            color: var(--error);
            font-weight: 600;
            background: #FDE8E8;
            padding: 0.75rem;
            border-radius: var(--za-radius-sm);
            word-break: break-word;
            line-height: 1.4;
            position: relative;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .manage-product-notes::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--error);
            border-top-left-radius: var(--za-radius-sm);
            border-bottom-left-radius: var(--za-radius-sm);
        }
        
        .manage-product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f8f8f8;
            border-top: 1px solid #e0e0e0;
        }

        .manage-product-image-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .manage-product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--za-radius-sm);
            border: 1px solid #eee;
            cursor: pointer;
            /* é˜²æ­¢å›¾ç‰‡åŠ è½½å¯¼è‡´çš„å¸ƒå±€æŠ–åŠ¨ */
            background-color: #f0f0f0;
            /* ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“ */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .manage-product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit, .btn-remove {
            padding: 0.5rem 1rem;
            border-radius: var(--za-radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            min-width: 70px;
            /* é˜²æ­¢ç§»åŠ¨ç«¯ç‚¹å‡»é—ªçƒ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-edit { 
            background: var(--za-green-light); 
            color: white; 
        }
        .btn-remove { 
            background: var(--error); 
            color: white; 
        }
        
        /* ========== ä¼˜åŒ–åçš„å›¾ç‰‡ä¸Šä¼ æŒ‰é’®æ ·å¼ ========== */
        .image-upload-single {
            background: #f0f9f8;
            border: 2px dashed var(--za-green-light);
            padding: 1rem;
            border-radius: var(--za-radius-sm);
            margin-bottom: 1rem;
        }
        
        .image-upload-batch {
            background: #fff8e6;
            border: 2px dashed var(--warning);
            padding: 1rem;
            border-radius: var(--za-radius-sm);
            margin-bottom: 1rem;
        }
        
        .image-upload-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .image-upload-single .image-upload-label {
            color: var(--za-green-dark);
        }
        
        .image-upload-batch .image-upload-label {
            color: var(--warning);
        }
        
        /* æ•°æ®å¤‡ä»½æ¨¡å—æ ·å¼ */
        .upload-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .upload-card {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            padding: var(--spacing);
            border-radius: var(--za-radius-md);
            box-shadow: var(--za-shadow-sm);
            overflow: hidden; 
        }

        .upload-card h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--za-green-dark);
            margin-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }

        .files-list-container {
            margin-top: 1.5rem;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #e0e0e0;
            padding-top: 1rem;
            /* æ”¹å–„ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒ */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }

        .file-item {
            background: var(--za-surface);
            padding: 0.75rem;
            border-radius: var(--za-radius-sm);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            box-shadow: var(--za-shadow-sm);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--za-green-light);
            border-top-left-radius: var(--za-radius-sm);
            border-bottom-left-radius: var(--za-radius-sm);
        }

        .file-name { font-weight: 600; }
        .file-info { color: var(--za-text-secondary); font-size: 0.8125rem; }

        /* çŠ¶æ€æ¶ˆæ¯ */
        .status-msg {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--za-radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
        }
        .status-success { background: #E6F7E9; color: var(--success); }
        .status-error { background: #FDE8E8; color: var(--error); }
        .status-loading { background: #EFF6FF; color: #007AFF; }
        
        /* Cloudflare R2é…ç½®åŒºåŸŸ */
        .r2-config {
            background: #f0f9f8;
            border: 1px solid var(--za-green-light);
            border-radius: var(--za-radius-md);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
        }
        
        .r2-config h3 {
            color: var(--za-green-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .r2-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .header-section {
                padding: 1.5rem 1rem;
                margin-bottom: 1rem;
            }
            .app-title { font-size: 1.3rem; }
            .app-subtitle { font-size: 0.8rem; }
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }
            .stat-number { font-size: 1.1rem; }
            .stat-label { font-size: 0.6rem; }
            .storage-status-bar {
                flex-direction: column;
                gap: 0.25rem;
                font-size: 0.6rem;
            }
            .tab-bar {
                padding: 0.25rem;
                margin: 0 1rem 1rem 1rem;
            }
            .tab-button {
                font-size: 0.875rem;
                padding: 0.6rem 0.3rem;
            }
            .main-content {
                padding: 0 1rem 1rem 1rem;
            }
            .module-title {
                font-size: 1.15rem;
                margin-bottom: 1rem;
            }
            .manage-form {
                grid-template-columns: 1fr;
            }
            .za-btn {
                min-width: 100%;
                font-size: 0.9rem;
            }
            .button-row {
                flex-direction: column;
            }
            
            /* ç§»åŠ¨ç«¯ç®¡ç†å¡ç‰‡ */
            .manage-product-card {
                margin-bottom: 1rem;
            }
            
            .manage-specs-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .manage-product-full-row {
                grid-column: 1;
            }
            
            .manage-product-footer {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            
            .manage-product-image-container {
                justify-content: center;
            }
            
            .manage-product-actions {
                justify-content: center;
            }
            
            /* ç§»åŠ¨ç«¯R2é…ç½® */
            .r2-config-grid {
                grid-template-columns: 1fr;
            }
            
            /* æ”¹å–„ç§»åŠ¨ç«¯æ»šåŠ¨æ€§èƒ½ */
            .manage-product-list {
                -webkit-overflow-scrolling: touch;
                overflow-scrolling: touch;
            }
        }

        @media (min-width: 601px) {
            /* æ¡Œé¢ç«¯ç®¡ç†å¡ç‰‡å¸ƒå±€ä¼˜åŒ– */
            .manage-product-card {
                flex-direction: row;
                min-height: 180px;
            }
            
            .manage-product-content {
                flex: 1;
                min-width: 0;
            }
            
            .manage-product-footer {
                flex-direction: column;
                justify-content: space-between;
                width: 140px;
                flex-shrink: 0;
                border-top: none;
                border-left: 1px solid #e0e0e0;
            }
            
            .manage-product-image-container {
                flex-direction: column;
            }
            
            .manage-product-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-edit, .btn-remove {
                width: 100%;
            }
        }

        /* ç»Ÿä¸€çš„ Modal æ ·å¼ - ä¿®å¤å›¾ç‰‡æ»‘åŠ¨é—®é¢˜ */
        .image-modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            /* ä¿®å¤ï¼šå…è®¸è§¦æ‘¸æ»šåŠ¨ */
            touch-action: pan-y;
            overflow-y: auto;
        }
        .image-modal.active {
            display: flex;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--za-radius-md);
            overflow: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            animation: fadeIn 0.3s ease;
            /* ä¿®å¤ï¼šå…è®¸è§¦æ‘¸æ»šåŠ¨ */
            touch-action: pan-y;
        }
        .modal-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
            /* ä¿®å¤ï¼šå…è®¸è§¦æ‘¸æ»‘åŠ¨ */
            touch-action: pan-y;
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            overflow: hidden; 
            z-index: 1001;
        }
        .close-modal:hover { background: #d32f2f; }
        
        /* ä¸Šä¼ è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--za-gradient);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* ç®¡ç†äº§å“åˆ—è¡¨å®¹å™¨ - ä¿®å¤ç™½å±é—®é¢˜çš„å…³é”® */
        .manage-product-list {
            margin-top: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
            /* æ”¹å–„ç§»åŠ¨ç«¯æ»šåŠ¨æ€§èƒ½ */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* é˜²æ­¢é‡ç»˜é—®é¢˜ */
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            /* ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ */
            will-change: transform;
            contain: layout style paint;
        }
        
        /* åˆ†é¡µåŠ è½½æŒ‰é’® */
        .load-more-container {
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
        }
        
        .load-more-btn {
            background: var(--za-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--za-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--za-shadow-sm);
        }
        
        .load-more-btn:active {
            transform: translateY(1px);
        }
        
        /* å­˜å‚¨çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .storage-status {
            background: #e6f3ff;
            border: 1px solid #b3d9ff;
            border-radius: var(--za-radius-sm);
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .storage-status.warning {
            background: #fff8e6;
            border-color: #ffd699;
        }
        
        .storage-status.error {
            background: #ffe6e6;
            border-color: #ff9999;
        }
        
        /* R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .r2-backup-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: var(--za-radius-sm);
            margin-top: 1rem;
        }
        
        .r2-backup-item {
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .r2-backup-item:hover {
            background: #f0f9f8;
        }
        
        .r2-backup-item:last-child {
            border-bottom: none;
        }
        
        .backup-file-info {
            display: flex;
            flex-direction: column;
        }
        
        .backup-file-name {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .backup-file-size {
            font-size: 0.75rem;
            color: var(--za-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ¸å˜ Header (ä»¿ZA Bank) -->
        <div class="header-section">
            <div class="app-title">
                <span style="font-size: 1.8rem; margin-right: 5px;">ğŸ“Š</span> å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿ
            </div>
            <p class="app-subtitle">æ™ºèƒ½æŸ¥è¯¢ Â· æ•°æ®ç®¡ç† Â· ä¸“ä¸šæŠ¥ä»·</p>
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-number" id="dataCount">0</div>
                    <div class="stat-label">äº§å“æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="r2ImageCount">0</div>
                    <div class="stat-label">R2å›¾ç‰‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="localImageCount">0</div>
                    <div class="stat-label">æœ¬åœ°å›¾ç‰‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="missingImageCount">0</div>
                    <div class="stat-label">ç¼ºå¤±å›¾ç‰‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="storageUsage">0</div>
                    <div class="stat-label">å­˜å‚¨ç”¨é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="systemHealth">0</div>
                    <div class="stat-label">ç³»ç»Ÿå¥åº·</div>
                </div>
            </div>
            <div class="storage-status-bar">
                <div class="storage-status-item">
                    <span>ğŸ’¾ å­˜å‚¨åˆ†å¸ƒ:</span>
                    <span class="storage-status-badge storage-local" id="localStorageBadge">æœ¬åœ°å­˜å‚¨: 0</span>
                    <span class="storage-status-badge storage-r2" id="r2StorageBadge">R2å­˜å‚¨: 0</span>
                </div>
                <div class="storage-status-item">
                    <span id="storageSyncStatus">ğŸ”„ åŒæ­¥ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆªæ  -->
        <div class="tab-bar">
            <button class="tab-button active" id="tabQueryBtn" onclick="switchTab('query')">
                <span>ğŸ”</span> æŸ¥è¯¢æŠ¥ä»·
            </button>
            <button class="tab-button" id="tabManageBtn" onclick="switchTab('manage')">
                <span>ğŸ› ï¸</span> äº§å“ç®¡ç†
            </button>
            <button class="tab-button" id="tabDataBtn" onclick="switchTab('data')">
                <span>ğŸ“¦</span> æ•°æ®å¤‡ä»½
            </button>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- 1. æŸ¥è¯¢æŠ¥ä»·æ¨¡å— -->
            <div class="tab-content active" id="tabQuery">
                <h2 class="module-title">äº§å“æ™ºèƒ½æŸ¥è¯¢</h2>
                <div class="search-box">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <textarea id="searchInput" class="search-input" rows="3" placeholder="è¾“å…¥äº§å“ä»£ç ã€ä¾›åº”å•†æˆ–ä»·æ ¼/å…‹é‡åŒºé—´...&#10;&#10;ç¤ºä¾‹ï¼š&#10;â€¢ äº§å“ä»£ç ï¼šC6001, Y6&#10;â€¢ ä¾›åº”å•†ï¼šæ°¸è”&#10;â€¢ ä»·æ ¼åŒºé—´ï¼š20å…ƒä»¥ä¸Š, 10-15å…ƒ&#10;â€¢ å…‹é‡åŒºé—´ï¼š100å…‹å†…, 150-200å…‹"></textarea>
                </div>
                <p class="hint-text">ğŸ’¡ å®æ—¶æ™ºèƒ½æœç´¢å·²å¼€å¯ï¼šè¾“å…¥å³è‡ªåŠ¨åŒ¹é…äº§å“ä»£ç ã€ä¾›åº”å•†ã€ä»·æ ¼/å…‹é‡åŒºé—´ã€‚æ”¯æŒæ‰¹é‡æŸ¥è¯¢ã€æ¨¡ç³Šæœç´¢ä¸å†å²è®°å½•å¿«é€Ÿè°ƒç”¨ã€‚</p>

                <!-- æœç´¢å†å² -->
                <h3 class="module-title" style="font-size: 1rem; margin-bottom: 0.5rem; border-bottom: none;">
                    <span style="font-size: 1.25rem;">âŒš</span> æœç´¢å†å²
                </h3>
                <div class="search-history" id="searchHistory"></div>

                <div class="button-row">
                    <button class="za-btn za-btn-primary" onclick="exportQuotePDF()" id="quotePDFBtn" style="display: none;">
                        <span>ğŸ“„</span> å¯¼å‡ºæŠ¥ä»·PDF
                    </button>
                    <button class="za-btn za-btn-secondary" onclick="clearSearchHistory()">
                        <span>ğŸ—‘ï¸</span> æ¸…é™¤å†å²
                    </button>
                </div>
                
                <div id="resultsArea" style="margin-top: var(--spacing);"></div>
            </div>

            <!-- 2. äº§å“ç®¡ç†æ¨¡å— -->
            <div class="tab-content" id="tabManage">
                <h2 class="module-title">äº§å“æ•°æ®ç»´æŠ¤</h2>
                
                <!-- å­˜å‚¨çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="storageStatus" class="storage-status" style="display: none;">
                    <span>ğŸ’¾</span>
                    <span id="storageStatusText">å­˜å‚¨çŠ¶æ€æ­£å¸¸</span>
                </div>
                
                <div class="upload-card">
                    <h3>â• æ·»åŠ /ç¼–è¾‘äº§å“</h3>
                    <form class="manage-form" id="manageForm">
                        <div class="manage-input-group">
                            <label for="codeInput">äº§å“ä»£ç </label>
                            <input type="text" id="codeInput" class="manage-input" required placeholder="ä¾‹å¦‚ï¼šC6001, YC2001">
                        </div>
                        <div class="manage-input-group">
                            <label for="priceInput">ç ä»·</label>
                            <input type="text" id="priceInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š12.5å…ƒ/ç ">
                        </div>
                        <div class="manage-input-group">
                            <label for="priceAltInput">ç±³ä»·</label>
                            <input type="text" id="priceAltInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š12.5å…ƒ/ç±³-è¶³ç±³">
                        </div>
                        <div class="manage-input-group">
                            <label for="widthInput">é—¨å¹…</label>
                            <input type="text" id="widthInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š150cm">
                        </div>
                        <div class="manage-input-group">
                            <label for="compositionInput">æˆåˆ†</label>
                            <input type="text" id="compositionInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š100é”¦çº¶">
                        </div>
                        <div class="manage-input-group">
                            <label for="weightInput">å…‹é‡</label>
                            <input type="text" id="weightInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š90å…‹/å¹³æ–¹ï¼ˆgsmï¼‰">
                        </div>
                        <div class="manage-input-group">
                            <label for="notesInput">å¤‡æ³¨</label>
                            <input type="text" id="notesInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼šé¢œè‰²ä»·æ ¼è¯´æ˜ç­‰">
                        </div>
                        <div class="manage-input-group">
                            <label for="supplierInput">ä¾›åº”å•†</label>
                            <input type="text" id="supplierInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼šå‡¯æ³“K5ã€KH86ã€‘">
                        </div>
                        
                        <!-- å•å¼ å›¾ç‰‡ä¸Šä¼  -->
                        <div class="manage-input-group image-upload-single">
                            <label for="imageInput" class="image-upload-label">ğŸ“· åº•å¡å›¾ç‰‡ï¼ˆå•å¼ ï¼‰</label>
                            <input type="file" id="imageInput" class="manage-input" accept="image/*">
                            <div class="progress-bar" id="imageUploadProgress" style="display: none;">
                                <div class="progress-fill" id="imageUploadProgressFill"></div>
                            </div>
                        </div>
                        
                        <!-- æ‰¹é‡å›¾ç‰‡ä¸Šä¼  -->
                        <div class="manage-input-group image-upload-batch">
                            <label for="bulkImageInput" class="image-upload-label">ğŸ“¸ åº•å¡å›¾ç‰‡ï¼ˆæ‰¹é‡ï¼‰</label>
                            <input type="file" id="bulkImageInput" class="manage-input" multiple accept="image/*">
                            <div class="progress-bar" id="bulkImageUploadProgress" style="display: none;">
                                <div class="progress-fill" id="bulkImageUploadProgressFill"></div>
                            </div>
                        </div>
                        
                        <div class="manage-btn-row">
                            <button type="button" class="za-btn za-btn-success" id="addBtn" onclick="addOrUpdateProduct()">æ·»åŠ äº§å“</button>
                            <button type="button" class="za-btn za-btn-primary" id="updateBtn" onclick="addOrUpdateProduct()" style="display: none;">æ›´æ–°äº§å“</button>
                            <button type="button" class="za-btn za-btn-error" id="deleteBtn" onclick="deleteProduct()" style="display: none;">åˆ é™¤äº§å“</button>
                            <button type="button" class="za-btn za-btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                        </div>
                        <div id="manageFormStatus" class="status-msg" style="grid-column: 1 / -1; display: none;"></div>
                    </form>
                </div>
                
                <div class="upload-card" style="margin-top: var(--spacing);">
                    <h3>ğŸ” äº§å“åˆ—è¡¨ä¸æœç´¢</h3>
                    <div class="search-box" style="margin-bottom: 0;">
                        <svg class="search-icon" style="top: 0.8rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="manageSearchInput" class="manage-search" placeholder="æœç´¢äº§å“ä»£ç æˆ–ä¾›åº”å•†..." oninput="filterManageProducts()" style="padding-left: 3rem;">
                    </div>
                    <div class="manage-product-list" id="manageProductList"></div>
                    <div class="load-more-container" id="loadMoreContainer" style="display: none;">
                        <button class="load-more-btn" onclick="loadMoreProducts()">åŠ è½½æ›´å¤š</button>
                    </div>
                </div>
            </div>

            <!-- 3. æ•°æ®å¤‡ä»½æ¨¡å— -->
            <div class="tab-content" id="tabData">
                <h2 class="module-title">æ•°æ®å¤‡ä»½</h2>
                
                <div id="dataStatusMsg"></div>
                
                <!-- Cloudflare R2é…ç½®åŒºåŸŸ -->
                <div class="r2-config">
                    <h3>â˜ï¸ Cloudflare R2 + è‡ªå®šä¹‰åŸŸåé…ç½®</h3>
                    <div class="r2-config-grid">
                        <div class="manage-input-group">
                            <label for="r2AccountId">Account ID</label>
                            <input type="text" id="r2AccountId" class="manage-input" placeholder="è¯·è¾“å…¥Cloudflare Account ID">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2AccessKey">Access Key ID</label>
                            <input type="text" id="r2AccessKey" class="manage-input" placeholder="è¯·è¾“å…¥R2 Access Key ID">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2SecretKey">Secret Access Key</label>
                            <input type="password" id="r2SecretKey" class="manage-input" placeholder="è¯·è¾“å…¥R2 Secret Access Key">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2Bucket">Bucket åç§°</label>
                            <input type="text" id="r2Bucket" class="manage-input" placeholder="è¯·è¾“å…¥å­˜å‚¨æ¡¶åç§°">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2CustomDomain">è‡ªå®šä¹‰åŸŸå</label>
                            <input type="text" id="r2CustomDomain" class="manage-input" placeholder="https://img.yudong-textile.top" value="https://img.yudong-textile.top">
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="za-btn za-btn-primary" onclick="saveR2Config()">ä¿å­˜é…ç½®</button>
                        <button class="za-btn za-btn-secondary" onclick="testR2Connection()">æµ‹è¯•è¿æ¥</button>
                        <button class="za-btn za-btn-warning" onclick="migrateImagesToR2()">è¿ç§»å›¾ç‰‡åˆ°R2</button>
                    </div>
                    <p class="hint-text" style="margin-top: 1rem; margin-bottom: 0;">
                        ğŸ’¡ é…ç½®è¯´æ˜ï¼šåœ¨Cloudflareæ§åˆ¶å°åˆ›å»ºR2å­˜å‚¨æ¡¶ï¼Œå°†æ‚¨çš„åŸŸå img.yudong-textile.top é€šè¿‡CNAMEè®°å½•æŒ‡å‘R2å­˜å‚¨æ¡¶ã€‚
                    </p>
                </div>
                
                <div class="upload-section">
                    <!-- æ•°æ®ä¸Šä¼ ä¸å¯¼å…¥ -->
                    <div class="upload-card">
                        <h3>ğŸ“¤ æ•°æ®ä¸Šä¼ ä¸å¯¼å…¥</h3>
                        <div class="button-row" style="margin-top: 0;">
                            <input type="file" id="localDbInput" accept=".json,.zip" style="display: none;">
                            <button class="za-btn za-btn-primary" onclick="document.getElementById('localDbInput').click()">
                                <span>ğŸ“‚</span> æœ¬åœ°DBå¯¼å…¥
                            </button>
                            
                            <button class="za-btn za-btn-success" onclick="loadR2BackupFiles()">
                                <span>â˜ï¸</span> Cloudflare R2å¯¼å…¥
                            </button>
                        </div>
                        
                        <!-- R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ -->
                        <div id="r2BackupList" class="r2-backup-list" style="display: none;">
                            <!-- R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <p class="hint-text" style="margin-top: 1rem; margin-bottom: 0;">å¯¼å…¥æ•°æ®åº“å°†è¦†ç›–å½“å‰æ‰€æœ‰äº§å“æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
                    </div>

                    <!-- å¤‡ä»½ä¸æ¸…ç©º -->
                    <div class="upload-card">
                        <h3>ğŸ“¥ æ•°æ®å¤‡ä»½ä¸æ¸…ç©º</h3>
                        <div class="button-row" style="margin-top: 0;">
                            <button class="za-btn za-btn-warning" onclick="exportAndUploadBackup()">
                                <span>ZIP</span> å¯¼å‡ºå®Œæ•´å¤‡ä»½
                            </button>
                            <button class="za-btn za-btn-error" onclick="clearData()">
                                <span>âš ï¸</span> æ¸…ç©ºæ‰€æœ‰æ•°æ®
                            </button>
                        </div>
                        <p class="hint-text hint-error" style="margin-top: 1rem; margin-bottom: 0;">å®Œæ•´å¤‡ä»½åŒ…å«æ•°æ®è¡¨å’Œæ‰€æœ‰å›¾ç‰‡ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºã€‚</p>
                    </div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="upload-card">
                    <h3>ğŸ“‹ å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨</h3>
                    <div id="filesList" class="files-list-container">
                        <!-- æ–‡ä»¶åˆ—è¡¨å†…å®¹ç”± JS æ¸²æŸ“ -->
                    </div>
                </div>
                
            </div>
            
        </div>
        
        <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
        <div id="imageModal" class="image-modal">
            <div class="modal-content">
                <img id="modalImage" class="modal-image" src="" alt="äº§å“åº•å¡">
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============== å…¨å±€å˜é‡å’Œåˆå§‹åŒ– ==============
        var catalogData = {};
        var uploadedFiles = [];
        var searchResults = [];
        var fuzzyMatches = [];
        var rangeResults = [];
        var searchTimeout;
        var searchHistory = [];
        var editingCode = null;
        var manageSearchTerm = '';
        
        // Cloudflare R2é…ç½®
        var r2Config = JSON.parse(localStorage.getItem('r2-config') || '{}');
        var s3Client = null;
        
        // äº§å“ç®¡ç†åˆ†é¡µå˜é‡
        var manageCurrentPage = 1;
        var managePageSize = 20;
        var filteredManageProducts = [];
        var hasMoreProducts = false;

        // ============== Cloudflare R2åŠŸèƒ½ ==============
        function saveR2Config() {
            const accountId = document.getElementById('r2AccountId').value.trim();
            const accessKey = document.getElementById('r2AccessKey').value.trim();
            const secretKey = document.getElementById('r2SecretKey').value.trim();
            const bucket = document.getElementById('r2Bucket').value.trim();
            const customDomain = document.getElementById('r2CustomDomain').value.trim();
            
            if (!accountId || !accessKey || !secretKey || !bucket || !customDomain) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„Cloudflare R2é…ç½®', 'error', 'dataStatusMsg');
                return;
            }
            
            // ç¡®ä¿customDomainä»¥æ–œæ ç»“å°¾
            const formattedCustomDomain = customDomain.endsWith('/') ? customDomain : customDomain + '/';
            
            r2Config = { 
                accountId, 
                accessKey, 
                secretKey, 
                bucket, 
                customDomain: formattedCustomDomain 
            };
            localStorage.setItem('r2-config', JSON.stringify(r2Config));
            showStatus('Cloudflare R2é…ç½®å·²ä¿å­˜', 'success', 'dataStatusMsg');
            
            // åˆå§‹åŒ–S3å®¢æˆ·ç«¯ (å…¼å®¹R2)
            initS3Client();
        }
        
        function loadR2Config() {
            document.getElementById('r2AccountId').value = r2Config.accountId || '';
            document.getElementById('r2AccessKey').value = r2Config.accessKey || '';
            document.getElementById('r2SecretKey').value = r2Config.secretKey || '';
            document.getElementById('r2Bucket').value = r2Config.bucket || '';
            document.getElementById('r2CustomDomain').value = r2Config.customDomain || 'https://img.yudong-textile.top';
            
            if (r2Config.accessKey && r2Config.secretKey) {
                initS3Client();
            }
        }
        
        function initS3Client() {
            if (!r2Config.accessKey || !r2Config.secretKey) return;
            
            try {
                AWS.config.update({
                    accessKeyId: r2Config.accessKey,
                    secretAccessKey: r2Config.secretKey,
                    region: 'auto'
                });
                
                s3Client = new AWS.S3({
                    endpoint: `https://${r2Config.accountId}.r2.cloudflarestorage.com`,
                    signatureVersion: 'v4'
                });
                
                console.log('Cloudflare R2 S3å®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
                // åˆå§‹åŒ–åç«‹å³åŠ è½½æ•°æ®
                loadDataFromR2();
            } catch (error) {
                console.error('S3å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('S3å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error', 'dataStatusMsg');
            }
        }
        
        function testR2Connection() {
            if (!r2Config.accessKey || !r2Config.bucket) {
                showStatus('è¯·å…ˆä¿å­˜Cloudflare R2é…ç½®', 'error', 'dataStatusMsg');
                return;
            }
            
            if (!s3Client) initS3Client();
            
            showStatus('æ­£åœ¨æµ‹è¯•R2è¿æ¥...', 'loading', 'dataStatusMsg');
            
            // ä½¿ç”¨ç®€å•æ–‡ä»¶ä¸Šä¼ æµ‹è¯•è¿æ¥
            const testContent = new Blob(['R2 Connection Test'], { type: 'text/plain' });
            const testKey = `test-connection-${Date.now()}.txt`;
            
            s3Client.putObject({
                Bucket: r2Config.bucket,
                Key: testKey,
                Body: testContent,
                ContentType: 'text/plain'
            }, function(err, data) {
                if (err) {
                    console.error('R2è¿æ¥æµ‹è¯•å¤±è´¥:', err);
                    let errorMsg = 'R2è¿æ¥æµ‹è¯•å¤±è´¥: ';
                    
                    if (err.statusCode === 403) {
                        errorMsg = 'æƒé™é”™è¯¯ï¼šè¯·æ£€æŸ¥Access Key/Secret Keyæ˜¯å¦æ­£ç¡®';
                    } else if (err.statusCode === 404) {
                        errorMsg = 'å­˜å‚¨æ¡¶ä¸å­˜åœ¨ï¼šè¯·æ£€æŸ¥Bucketåç§°æ˜¯å¦æ­£ç¡®';
                    } else if (err.statusCode === 400) {
                        errorMsg = 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼šè¯·æ£€æŸ¥é…ç½®æ ¼å¼';
                    } else if (err.code === 'NetworkingError' || err.message?.includes('CORS')) {
                        errorMsg = 'ç½‘ç»œé”™è¯¯ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CORSé…ç½®';
                    } else {
                        errorMsg += err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®';
                    }
                    
                    showStatus(errorMsg, 'error', 'dataStatusMsg');
                } else {
                    // æµ‹è¯•æˆåŠŸï¼Œåˆ é™¤æµ‹è¯•æ–‡ä»¶
                    s3Client.deleteObject({
                        Bucket: r2Config.bucket,
                        Key: testKey
                    }, function(deleteErr) {
                        if (deleteErr) {
                            console.warn('æµ‹è¯•æ–‡ä»¶åˆ é™¤å¤±è´¥:', deleteErr);
                        }
                    });
                    
                    // æµ‹è¯•è‡ªå®šä¹‰åŸŸåè®¿é—®
                    testCustomDomainAccess();
                }
            });
        }
        
        function testCustomDomainAccess() {
            if (!r2Config.customDomain) {
                showStatus('âœ… R2è¿æ¥æµ‹è¯•æˆåŠŸï¼é…ç½®æ­£ç¡®ã€‚', 'success', 'dataStatusMsg');
                return;
            }
            
            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾ç‰‡URL
            const testImageUrl = `${r2Config.customDomain}test-image-${Date.now()}.jpg`;
            
            // æµ‹è¯•å›¾ç‰‡åŠ è½½
            const testImage = new Image();
            testImage.onload = function() {
                showStatus('âœ… R2è¿æ¥æµ‹è¯•æˆåŠŸï¼è‡ªå®šä¹‰åŸŸåè®¿é—®æ­£å¸¸ã€‚', 'success', 'dataStatusMsg');
            };
            testImage.onerror = function() {
                showStatus('âš ï¸ R2è¿æ¥æˆåŠŸï¼Œä½†è‡ªå®šä¹‰åŸŸåè®¿é—®å¯èƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥åŸŸåè§£æã€‚', 'warning', 'dataStatusMsg');
            };
            testImage.src = testImageUrl;
        }
        
        // ä¸Šä¼ å›¾ç‰‡åˆ°Cloudflare R2 - ä½¿ç”¨è‡ªå®šä¹‰åŸŸå
        async function uploadToR2(file, productCode) {
            return new Promise((resolve, reject) => {
                if (!s3Client) {
                    reject(new Error('è¯·å…ˆé…ç½®Cloudflare R2'));
                    return;
                }
                
                // ä½¿ç”¨çº¯äº§å“ä»£ç ä½œä¸ºæ–‡ä»¶å
                const key = `yudong-fabric/${productCode}.jpg`;
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                document.getElementById('imageUploadProgress').style.display = 'block';
                document.getElementById('imageUploadProgressFill').style.width = '0%';
                
                s3Client.upload({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: file,
                    ContentType: file.type
                }, function(err, data) {
                    document.getElementById('imageUploadProgress').style.display = 'none';
                    
                    if (err) {
                        console.error('R2ä¸Šä¼ å¤±è´¥:', err);
                        reject(err);
                    } else {
                        // ä½¿ç”¨è‡ªå®šä¹‰åŸŸåæ„å»ºå›¾ç‰‡URL
                        const imageUrl = `${r2Config.customDomain}${productCode}.jpg`;
                        resolve(imageUrl);
                    }
                }).on('httpUploadProgress', function(progress) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    document.getElementById('imageUploadProgressFill').style.width = percent + '%';
                });
            });
        }
        
        // ä¸Šä¼ å¤‡ä»½æ–‡ä»¶åˆ°Cloudflare R2
        async function uploadBackupToR2(backupBlob, fileName) {
            return new Promise((resolve, reject) => {
                if (!s3Client) {
                    reject(new Error('è¯·å…ˆé…ç½®Cloudflare R2'));
                    return;
                }
                
                const key = `yudong-cloud/${fileName}`;
                
                s3Client.upload({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: backupBlob,
                    ContentType: 'application/zip'
                }, function(err, data) {
                    if (err) {
                        console.error('å¤‡ä»½ä¸Šä¼ å¤±è´¥:', err);
                        reject(err);
                    } else {
                        resolve(data);
                    }
                });
            });
        }
        
        // ä»Cloudflare R2åŠ è½½å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
        async function loadR2BackupFiles() {
            if (!s3Client) {
                showStatus('è¯·å…ˆé…ç½®Cloudflare R2', 'error', 'dataStatusMsg');
                return;
            }
            
            showStatus('æ­£åœ¨åŠ è½½R2å¤‡ä»½æ–‡ä»¶...', 'loading', 'dataStatusMsg');
            
            s3Client.listObjectsV2({
                Bucket: r2Config.bucket,
                Prefix: 'yudong-cloud/'
            }, function(err, data) {
                if (err) {
                    console.error('åŠ è½½å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', err);
                    showStatus('åŠ è½½å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + err.message, 'error', 'dataStatusMsg');
                    return;
                }
                
                const backupFiles = data.Contents.filter(item => 
                    item.Key.endsWith('.zip') && item.Key.startsWith('yudong-cloud/')
                ).sort((a, b) => new Date(b.LastModified) - new Date(a.LastModified));
                
                renderR2BackupList(backupFiles);
                showStatus(`æ‰¾åˆ° ${backupFiles.length} ä¸ªå¤‡ä»½æ–‡ä»¶`, 'success', 'dataStatusMsg');
            });
        }
        
        // æ¸²æŸ“R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
        function renderR2BackupList(backupFiles) {
            const backupList = document.getElementById('r2BackupList');
            
            if (backupFiles.length === 0) {
                backupList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--za-text-secondary);">æš‚æ— å¤‡ä»½æ–‡ä»¶</div>';
                backupList.style.display = 'block';
                return;
            }
            
            let html = '';
            backupFiles.forEach(file => {
                const fileName = file.Key.replace('yudong-cloud/', '');
                const fileSize = formatBytes(file.Size);
                const lastModified = new Date(file.LastModified).toLocaleString('zh-CN');
                
                html += `
                    <div class="r2-backup-item" onclick="importFromR2Backup('${file.Key}')">
                        <div class="backup-file-info">
                            <div class="backup-file-name">${fileName}</div>
                            <div class="backup-file-size">${fileSize} Â· ${lastModified}</div>
                        </div>
                        <span>â¬‡ï¸</span>
                    </div>
                `;
            });
            
            backupList.innerHTML = html;
            backupList.style.display = 'block';
        }
        
        // ä»R2å¤‡ä»½æ–‡ä»¶å¯¼å…¥æ•°æ®
        function importFromR2Backup(fileKey) {
            if (!confirm('ç¡®å®šè¦ä»è¯¥å¤‡ä»½æ–‡ä»¶å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚')) {
                return;
            }
            
            showStatus('æ­£åœ¨ä»R2å¤‡ä»½å¯¼å…¥æ•°æ®...', 'loading', 'dataStatusMsg');
            
            s3Client.getObject({
                Bucket: r2Config.bucket,
                Key: fileKey
            }, function(err, data) {
                if (err) {
                    console.error('ä¸‹è½½å¤‡ä»½æ–‡ä»¶å¤±è´¥:', err);
                    showStatus('ä¸‹è½½å¤‡ä»½æ–‡ä»¶å¤±è´¥: ' + err.message, 'error', 'dataStatusMsg');
                    return;
                }
                
                const blob = new Blob([data.Body], { type: 'application/zip' });
                importDatabase([new File([blob], fileKey.split('/').pop())]);
            });
        }
        
        // ä¿å­˜æ•°æ®åˆ°Cloudflare R2
        async function saveDataToR2() {
            if (!s3Client) {
                console.warn('R2æœªé…ç½®ï¼Œæ— æ³•ä¿å­˜æ•°æ®åˆ°äº‘ç«¯');
                return;
            }
            
            const dataToSave = {
                catalogData: catalogData,
                uploadedFiles: uploadedFiles,
                searchHistory: searchHistory,
                saveTime: new Date().toISOString(),
                version: '4.0-r2'
            };
            
            const dataBlob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const key = 'yudong-cloud/database.json';
            
            try {
                await s3Client.upload({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: dataBlob,
                    ContentType: 'application/json'
                }).promise();
                
                console.log('æ•°æ®å·²ä¿å­˜åˆ°R2');
                updateStorageStats();
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®åˆ°R2å¤±è´¥:', error);
            }
        }
        
        // ä»Cloudflare R2åŠ è½½æ•°æ®
        async function loadDataFromR2() {
            if (!s3Client) {
                console.warn('R2æœªé…ç½®ï¼Œæ— æ³•ä»äº‘ç«¯åŠ è½½æ•°æ®');
                return;
            }
            
            try {
                const data = await s3Client.getObject({
                    Bucket: r2Config.bucket,
                    Key: 'yudong-cloud/database.json'
                }).promise();
                
                const dataToLoad = JSON.parse(data.Body.toString());
                catalogData = dataToLoad.catalogData || {};
                uploadedFiles = dataToLoad.uploadedFiles || [];
                searchHistory = dataToLoad.searchHistory || [];
                
                console.log('æ•°æ®å·²ä»R2åŠ è½½');
                updateStats();
                renderHistory();
                updateStorageStats();
            } catch (error) {
                console.warn('ä»R2åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®:', error);
                catalogData = {};
                uploadedFiles = [];
                searchHistory = [];
            }
        }
        
        // ============== UI/çŠ¶æ€/åŠŸèƒ½å‡½æ•° ==============
        function updateStats() {
            document.getElementById('dataCount').textContent = Object.keys(catalogData).length;
            
            // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ ç»Ÿè®¡
            updateStorageStats();
            
            // æŠ¥ä»·PDFæŒ‰é’®æ§åˆ¶
            var hasResults = searchResults.length > 0 || rangeResults.length > 0;
            document.getElementById('quotePDFBtn').style.display = hasResults ? 'inline-block' : 'none';
        }
        
        // æ›´æ–°å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯
        function updateStorageStats() {
            const totalProducts = Object.keys(catalogData).length;
            let r2Images = 0;
            let localImages = 0;
            let missingImages = 0;
            
            Object.values(catalogData).forEach(product => {
                if (product.image) {
                    if (product.image.includes(r2Config.customDomain) || product.image.includes('.r2.cloudflarestorage.com')) {
                        r2Images++;
                    } else if (product.image.startsWith('data:image')) {
                        localImages++;
                    } else {
                        // å…¶ä»–ç±»å‹çš„å›¾ç‰‡é“¾æ¥è§†ä¸ºR2å›¾ç‰‡ï¼ˆå‡è®¾ä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼‰
                        r2Images++;
                    }
                } else {
                    missingImages++;
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('r2ImageCount').textContent = r2Images;
            document.getElementById('localImageCount').textContent = localImages;
            document.getElementById('missingImageCount').textContent = missingImages;
            
            // æ›´æ–°å­˜å‚¨ç”¨é‡ï¼ˆä¼°ç®—ï¼‰
            const estimatedSize = estimateDataSize();
            document.getElementById('storageUsage').textContent = formatBytes(estimatedSize, 1);
            
            // æ›´æ–°ç³»ç»Ÿå¥åº·çŠ¶æ€
            const healthScore = calculateHealthScore(totalProducts, r2Images, missingImages);
            document.getElementById('systemHealth').textContent = healthScore;
            
            // æ›´æ–°å­˜å‚¨åˆ†å¸ƒ
            document.getElementById('localStorageBadge').textContent = `æœ¬åœ°: ${localImages}`;
            document.getElementById('r2StorageBadge').textContent = `R2: ${r2Images}`;
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€
            document.getElementById('storageSyncStatus').textContent = s3Client ? 'âœ… äº‘ç«¯åŒæ­¥' : 'âš ï¸ ä»…æœ¬åœ°';
        }
        
        function estimateDataSize() {
            let size = 0;
            
            // ä¼°ç®—catalogDataå¤§å°
            const dataStr = JSON.stringify(catalogData);
            size += new Blob([dataStr]).size;
            
            // ä¼°ç®—å›¾ç‰‡å¤§å° (base64å›¾ç‰‡)
            Object.values(catalogData).forEach(product => {
                if (product.image && product.image.startsWith('data:image')) {
                    // base64å›¾ç‰‡å¤§å°çº¦ä¸ºåŸå§‹æ•°æ®çš„4/3
                    size += product.image.length * 3 / 4;
                }
            });
            
            return size;
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function calculateHealthScore(totalProducts, r2Images, missingImages) {
            if (totalProducts === 0) return '0%';
            
            let score = 100;
            
            // ç¼ºå¤±å›¾ç‰‡æ‰£åˆ†
            score -= (missingImages / totalProducts) * 50;
            
            // R2å›¾ç‰‡æ¯”ä¾‹åŠ åˆ†
            const r2Ratio = r2Images / (totalProducts - missingImages);
            score += r2Ratio * 20;
            
            // ç¡®ä¿åˆ†æ•°åœ¨0-100ä¹‹é—´
            score = Math.max(0, Math.min(100, score));
            
            return Math.round(score) + '%';
        }

        function showStatus(message, type, targetId = 'dataStatusMsg') {
            var statusDiv = document.getElementById(targetId);
            if (!statusDiv) return;

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-msg status-' + type;
            statusDiv.innerHTML = message;

            if (type === 'success' || type === 'error') {
                setTimeout(function() { statusDiv.style.display = 'none'; }, 5000);
            }
        }
        
        // --- å­˜å‚¨çŠ¶æ€ç›‘æ§ ---
        function checkStorageStatus() {
            const storageStatus = document.getElementById('storageStatus');
            const storageStatusText = document.getElementById('storageStatusText');
            
            // è®¡ç®—å½“å‰æ•°æ®å¤§å°
            const dataSize = estimateDataSize();
            
            // è®¾ç½®é˜ˆå€¼
            const warningThreshold = 10 * 1024 * 1024; // 10MB
            const criticalThreshold = 30 * 1024 * 1024; // 30MB
            
            if (dataSize > criticalThreshold) {
                storageStatus.className = 'storage-status error';
                storageStatusText.innerHTML = `âš ï¸ å­˜å‚¨ç©ºé—´ç´§å¼  (${formatBytes(dataSize)}) - å»ºè®®ç«‹å³è¿ç§»åˆ°Cloudflare R2`;
                storageStatus.style.display = 'flex';
            } else if (dataSize > warningThreshold) {
                storageStatus.className = 'storage-status warning';
                storageStatusText.innerHTML = `ğŸ’¾ å­˜å‚¨ä½¿ç”¨é‡è¾ƒé«˜ (${formatBytes(dataSize)}) - å»ºè®®é…ç½®Cloudflare R2`;
                storageStatus.style.display = 'flex';
            } else {
                storageStatus.style.display = 'none';
            }
        }
        
        // --- æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘ ---
        var tabCache = {
            query: true,
            manage: false,
            data: false
        };

        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œå†…å®¹çš„ active çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // æ¿€æ´»å½“å‰æ ‡ç­¾é¡µ
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Btn').classList.add('active');

            // å»¶è¿ŸåŠ è½½éæ´»åŠ¨æ ‡ç­¾é¡µå†…å®¹
            if (tabName === 'manage' && !tabCache.manage) {
                setTimeout(() => {
                    renderManageProducts();
                    tabCache.manage = true;
                }, 50);
            } else if (tabName === 'data' && !tabCache.data) {
                setTimeout(() => {
                    renderFilesList();
                    loadR2Config();
                    tabCache.data = true;
                }, 50);
            }
            
            // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
            if (tabName === 'manage') {
                setTimeout(checkStorageStatus, 100);
            }
        }

        // --- æœç´¢ç›¸å…³ ---
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            var value = e.target.value.trim();
            if (value && Object.keys(catalogData).length > 0) {
                searchTimeout = setTimeout(function() {
                    handleSearch(value);
                    renderResults();
                }, 300);
            } else {
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                renderResults();
            }
        });
        
        function renderHistory() {
            var historyDiv = document.getElementById('searchHistory');
            var html = '';
            searchHistory.slice(-5).reverse().forEach(function(h) {
                html += '<div class="history-item" onclick="loadHistory(\'' + h.replace(/'/g, "\\'") + '\')">' + h + '</div>';
            });
            historyDiv.innerHTML = html;
        }

        function loadHistory(query) {
            document.getElementById('searchInput').value = query;
            handleSearch(query);
            renderResults();
            switchTab('query');
        }

        function clearSearchHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ')) {
                searchHistory = [];
                saveDataToR2();
                renderHistory();
                showStatus('æœç´¢å†å²å·²æ¸…é™¤', 'success', 'dataStatusMsg');
            }
        }

        function parseRangeInput(input) {
            var ranges = [];
            var items = input.split(/[,ï¼Œ\s]+/).map(function(item) { return item.trim(); }).filter(function(item) { return item; });
            var type = null;
            items.forEach(function(item) {
                var upper = item.toUpperCase();
                var min = null, max = null, label = item;
                if (upper.includes('å…ƒ')) {
                    type = 'price';
                    if (upper.includes('ä»¥ä¸Š')) {
                        min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        max = Infinity;
                    } else if (upper.includes('å†…')) {
                        max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        min = 0;
                    } else {
                        var match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…ƒ/);
                        if (match) {
                            min = parseFloat(match[1]);
                            max = parseFloat(match[2]);
                        }
                    }
                } else if (upper.includes('å…‹')) {
                    type = 'weight';
                    if (upper.includes('ä»¥ä¸Š')) {
                        min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        max = Infinity;
                    } else if (upper.includes('å†…')) {
                        max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        min = 0;
                    } else {
                        var match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…‹/);
                        if (match) {
                            min = parseFloat(match[1]);
                            max = parseFloat(match[2]);
                        }
                    }
                }
                if (min !== null || max !== null) {
                    ranges.push({ min: min, max: max, label: label, type: type });
                }
            });
            return { ranges: ranges, type: type };
        }

        function performRangeQuery(ranges, type) {
            var results = [];
            var field = type === 'price' ? 'priceAlt' : 'weight';
            ranges.forEach(function(range) {
                var matches = [];
                Object.values(catalogData).forEach(function(product) {
                    var value = parseFloat(product[field]);
                    if (!isNaN(value) && value >= (range.min || 0) && value <= (range.max || Infinity)) {
                        var match = JSON.parse(JSON.stringify(product));
                        match.matchType = 'range';
                        match.rangeLabel = range.label;
                        matches.push(match);
                    }
                });
                matches.sort(function(a, b) {
                    var seriesA = a.code.match(/^[YC]*([ACDFGJMST])/);
                    var seriesB = b.code.match(/^[YC]*([ACDFGJMST])/);
                    seriesA = seriesA ? seriesA[1] : '';
                    seriesB = seriesB ? seriesB[1] : '';
                    if (seriesA !== seriesB) return seriesA.localeCompare(seriesB);
                    var numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                    var numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                    return numA - numB;
                });
                var result = JSON.parse(JSON.stringify(range));
                result.matches = matches;
                results.push(result);
            });
            return results;
        }

        function handleSearch(inputValue) {
            var input = (inputValue || document.getElementById('searchInput').value).trim().toUpperCase();
            if (!input) {
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                return;
            }
            if (!searchHistory.includes(input)) {
                searchHistory.push(input);
                if (searchHistory.length > 10) searchHistory.shift();
                saveDataToR2();
                renderHistory();
            }
            var parsed = parseRangeInput(input);
            if (parsed.ranges.length > 0 && (parsed.type === 'price' || parsed.type === 'weight')) {
                rangeResults = performRangeQuery(parsed.ranges, parsed.type);
                searchResults = [];
                fuzzyMatches = [];
            } else {
                var codes = input.split(/[\s,;\n]+/).map(function(c) { return c.trim(); }).filter(function(c) { return c.length > 0; });
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                codes.forEach(function(code) {
                    if (catalogData[code]) {
                        var result = JSON.parse(JSON.stringify(catalogData[code]));
                        result.found = true;
                        result.matchType = 'exact';
                        searchResults.push(result);
                    } else {
                        var matches = Object.keys(catalogData).filter(function(key) {
                            var product = catalogData[key];
                            var codeMatch = key.toUpperCase().includes(code);
                            var supplierMatch = product.supplier && product.supplier !== '-' &&
                                              product.supplier.toUpperCase().includes(code);
                            return codeMatch || supplierMatch;
                        });
                        if (matches.length === 1) {
                            var result = JSON.parse(JSON.stringify(catalogData[matches[0]]));
                            result.found = true;
                            result.matchType = 'fuzzy';
                            searchResults.push(result);
                        } else if (matches.length > 1) {
                            fuzzyMatches.push({ searchTerm: code, matches: matches.slice(0, 50) });
                        } else {
                            searchResults.push({ code: code, found: false, error: 'æœªæ‰¾åˆ°è¯¥äº§å“' });
                        }
                    }
                });
            }
        }

        function renderResults() {
            var area = document.getElementById('resultsArea');
            updateStats();
            
            if (Object.keys(catalogData).length === 0) {
                area.innerHTML = '<div class="empty-state" style="text-align: center; padding: 2rem;"><div class="empty-icon" style="font-size:3rem; color: #ccc;">ğŸ“¦</div><div class="empty-text" style="font-size:1.25rem;">æš‚æ— æ•°æ®</div><div class="empty-subtext">è¯·å…ˆä¸Šä¼  CSV æ–‡ä»¶</div></div>';
                return;
            }

            if (searchResults.length === 0 && fuzzyMatches.length === 0 && rangeResults.length === 0) {
                area.innerHTML = '';
                return;
            }

            var html = '';
            
            if (searchResults.length > 0) {
                var foundCount = searchResults.filter(function(r) { return r.found; }).length;
                html += '<div class="hint-text" style="margin-top: 1rem; background: #E6F7E9; border-color: var(--success);">ğŸ“Š å…±æŸ¥è¯¢ <strong>' + searchResults.length + '</strong> ä¸ªäº§å“ï¼Œæ‰¾åˆ° <strong>' + foundCount + '</strong> ä¸ªåŒ¹é…ç»“æœ</div>';
            }
            
            fuzzyMatches.forEach(function(fuzzy) {
                html += '<div class="product-card" style="padding: 1rem; margin-bottom: 1rem;"><div class="product-code" style="color: #92400E;">ğŸ” æ¨¡ç³Šæœç´¢ "' + fuzzy.searchTerm + '" æ‰¾åˆ° ' + fuzzy.matches.length + ' ä¸ªåŒ¹é…</div><div class="search-history" style="margin-bottom: 0;">';
                fuzzy.matches.forEach(function(m) {
                    html += '<div class="history-item" style="background: #FFFBEB; color: #92400E; border: 1px solid #FFE599;" onclick="selectFuzzyMatch(\'' + m + '\')">' + m + '</div>';
                });
                html += '</div></div>';
            });

            if (rangeResults.length > 0) {
                rangeResults.forEach(function(range) {
                    html += '<div class="product-card" style="padding: 0; margin-bottom: var(--spacing);"><div class="product-header" style="background: linear-gradient(90deg, #E6F7E9, #FFF); border-color: #ddd;"><div class="product-code" style="color: var(--success);">' + range.label + '</div><div class="match-badge" style="background: var(--success);">åŒ¹é… ' + range.matches.length + ' ä¸ªäº§å“</div></div>';
                    
                    if (range.matches.length > 0) {
                        var codes = range.matches.map(function(m) { return m.code; });
                        html += '<div style="padding: 1rem;"><h4 style="font-size: 0.9rem; font-weight: 700; color: var(--za-text-secondary); margin-bottom: 0.75rem;">ğŸ“‹ åŒ¹é…äº§å“ç¼–å· (' + codes.length + ' ä¸ª)</h4><div class="search-history">';
                        codes.forEach(function(code) {
                            html += '<div class="history-item" onclick="selectCode(\'' + code + '\')">' + code + '</div>';
                        });
                        html += '</div></div>';
                        
                        range.matches.forEach(function(product) {
                            html += renderProductCard(product);
                        });
                    } else {
                        html += '<div style="padding: 1rem;"><div class="empty-state" style="text-align: center; padding: 1rem;"><div class="empty-icon" style="font-size:2rem; color: #ccc;">ğŸ”</div><div class="empty-text" style="font-size:1rem;">æš‚æ— åŒ¹é…äº§å“</div><div class="empty-subtext">è¯¥åŒºé—´å†…æ²¡æœ‰æ‰¾åˆ°äº§å“</div></div></div>';
                    }
                    html += '</div>';
                });
            } else {
                searchResults.forEach(function(result) {
                    if (result.found) {
                        html += renderProductCard(result);
                    } else {
                        html += '<div class="product-card"><div class="product-content" style="text-align: center; padding: 1.5rem;"><div class="empty-icon" style="color: var(--error); font-size: 1.5rem;">âŒ</div><div class="product-code" style="color: var(--error); margin-top: 0.5rem;">' + result.code + '</div><div class="empty-subtext" style="margin-top: 0.25rem;">' + result.error + '</div></div></div>';
                    }
                });
            }
            area.innerHTML = html;
            bindImageEvents();
        }

        function renderProductCard(product) {
            var html = '<div class="product-card" data-code="' + product.code + '" style="margin: 1rem;">'; 
            html += '<div class="product-header">';
            html += '<div class="product-code">ğŸ“¦ ' + product.code + '</div>';
            html += '<div class="match-badge">' + (product.matchType === 'exact' ? 'âœ“ ç²¾ç¡®åŒ¹é…' : product.matchType === 'fuzzy' ? 'ğŸ¯ æ¨¡ç³ŠåŒ¹é…' : 'ğŸ“Š åŒºé—´åŒ¹é…') + '</div>';
            html += '</div>';
            html += '<div class="product-content">';
            
            // è§„æ ¼ç½‘æ ¼
            html += '<div class="specs-grid">';
            html += '<div class="spec-item"><label>ğŸ’° ç ä»· (Y)</label><div class="value">' + product.price + '</div></div>';
            html += '<div class="spec-item"><label>ğŸ’° ç±³ä»· (M)</label><div class="value">' + product.priceAlt + '</div></div>';
            html += '<div class="spec-item"><label>ğŸ“ é—¨å¹…</label><div class="value-normal">' + product.width + '</div></div>';
            html += '<div class="spec-item"><label>âš–ï¸ å…‹é‡</label><div class="value-normal">' + product.weight + '</div></div>';
            html += '<div class="spec-item" style="grid-column: span 2;"><label>ğŸ§µ æˆåˆ†</label><div class="value-normal">' + product.composition + '</div></div>';
            html += '</div>';

            if (product.notes && product.notes !== '-') {
                html += '<div class="hint-text hint-error" style="margin-bottom: 1rem;"><div style="font-weight: 700; color: var(--error); margin-bottom: 0.25rem;">âš ï¸ å¤‡æ³¨</div>' + product.notes + '</div>';
            }
            
            // ä¾›åº”å•†å¸ƒå±€
            html += '<div class="supplier-box">';
            html += '<span class="supplier-label">ğŸ­ ä¾›åº”å•†</span>';
            html += '<div class="supplier-details">'; 
            html += '<span class="supplier-name">' + (product.supplier && product.supplier !== '-' ? product.supplier : 'æš‚æ— ä¿¡æ¯') + '</span>';
            if (product.image) {
                html += '<a class="view-image-link" data-code="' + product.code + '" href="javascript:void(0);">æŸ¥çœ‹åº•å¡</a>';
            }
            html += '</div>';
            html += '</div>';
            
            html += '</div></div>';
            return html;
        }

        function showImage(imageSrc, productCode) {
            var modal = document.getElementById('imageModal');
            var modalImg = document.getElementById('modalImage');
            modalImg.src = imageSrc;
            modalImg.alt = 'äº§å“ ' + productCode + ' åº•å¡å›¾ç‰‡';
            modal.classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        function showImageByData(event) {
            const target = event.target.closest('a') || event.target;
            const code = target.dataset.code;
            if (code && catalogData[code] && catalogData[code].image) {
                showImage(catalogData[code].image, code);
            } else {
                showStatus('å›¾ç‰‡åŠ è½½å¤±è´¥æˆ–ä¸å­˜åœ¨', 'error', 'dataStatusMsg');
            }
        }
        
        function bindImageEvents() {
            const resultsArea = document.getElementById('resultsArea');
            if (resultsArea) {
                resultsArea.removeEventListener('click', handleImageLinkClick);
                resultsArea.addEventListener('click', handleImageLinkClick);
            }
            const manageList = document.getElementById('manageProductList');
            if (manageList) {
                manageList.removeEventListener('click', handleImageLinkClick);
                manageList.addEventListener('click', handleImageLinkClick);
            }
        }

        function handleImageLinkClick(e) {
            if (e.target.classList.contains('view-image-link') || e.target.classList.contains('manage-product-image')) {
                e.preventDefault();
                showImageByData(e);
            }
        }

        function selectFuzzyMatch(code) {
            document.getElementById('searchInput').value = code;
            handleSearch(code);
            renderResults();
            switchTab('query');
        }

        function selectCode(code) {
            document.getElementById('searchInput').value = code;
            handleSearch(code);
            renderResults();
            switchTab('query');
        }

        // --- äº§å“ç®¡ç† ---
        async function addOrUpdateProduct() {
            var code = document.getElementById('codeInput').value.trim().toUpperCase();
            if (!code || !code.match(/^[YC]*[ACDFGJMST]\d+/)) {
                showStatus('äº§å“ä»£ç æ ¼å¼æ— æ•ˆï¼ˆä¾‹å¦‚ï¼šC6001, YC2001ï¼‰', 'error', 'manageFormStatus');
                return;
            }
            if (catalogData[code] && editingCode !== code) {
                if (!confirm('äº§å“ä»£ç å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) return;
            }
            
            var imageFile = document.getElementById('imageInput').files[0];
            var imageUrl = catalogData[code] ? catalogData[code].image : null;
            
            if (imageFile) {
                if (imageFile.size > 5 * 1024 * 1024) {
                    showStatus('å›¾ç‰‡è¿‡å¤§ï¼ˆ>5MBï¼‰ï¼Œè¯·å‹ç¼©åä¸Šä¼ ', 'error', 'manageFormStatus');
                    return;
                }
                
                try {
                    // ä¸Šä¼ åˆ°Cloudflare R2ï¼Œä½¿ç”¨çº¯äº§å“ä»£ç å‘½å
                    imageUrl = await uploadToR2(imageFile, code);
                    showStatus('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success', 'manageFormStatus');
                } catch (error) {
                    console.error('Cloudflare R2ä¸Šä¼ å¤±è´¥:', error);
                    showStatus('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error', 'manageFormStatus');
                    return;
                }
            }
            
            saveProductData(code, imageUrl);
        }

        function saveProductData(code, imageUrl) {
            catalogData[code] = {
                code: code,
                price: document.getElementById('priceInput').value || '-',
                priceAlt: document.getElementById('priceAltInput').value || '-',
                width: document.getElementById('widthInput').value || '-',
                composition: document.getElementById('compositionInput').value || '-',
                weight: document.getElementById('weightInput').value || '-',
                notes: document.getElementById('notesInput').value || '-',
                supplier: document.getElementById('supplierInput').value || '-',
                image: imageUrl
            };
            
            saveDataToR2().then(() => {
                updateStats();
                renderManageProducts();
                if (editingCode) {
                    showStatus('äº§å“å·²æ›´æ–°', 'success', 'manageFormStatus');
                    clearForm();
                } else {
                    showStatus('äº§å“å·²æ·»åŠ ', 'success', 'manageFormStatus');
                    clearForm();
                }
                checkStorageStatus();
            }).catch(error => {
                console.error('Save error:', error);
                showStatus('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error', 'manageFormStatus');
            });
        }

        function editProduct(code) {
            var product = catalogData[code];
            if (!product) return;
            
            switchTab('manage');
            
            setTimeout(() => {
                const formElement = document.getElementById('manageForm').closest('.upload-card');
                if (formElement) {
                    formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100); 

            editingCode = code;
            document.getElementById('codeInput').value = product.code;
            document.getElementById('priceInput').value = product.price;
            document.getElementById('priceAltInput').value = product.priceAlt;
            document.getElementById('widthInput').value = product.width;
            document.getElementById('compositionInput').value = product.composition;
            document.getElementById('weightInput').value = product.weight;
            document.getElementById('notesInput').value = product.notes;
            document.getElementById('supplierInput').value = product.supplier;

            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'inline-block';
            document.getElementById('deleteBtn').style.display = 'inline-block';
            showStatus('ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹åç‚¹å‡»"æ›´æ–°äº§å“"', 'loading', 'manageFormStatus');
        }

        function deleteProduct() {
            if (!editingCode || !confirm('ç¡®å®šåˆ é™¤æ­¤äº§å“ ' + editingCode + ' å—ï¼Ÿ')) return;
            delete catalogData[editingCode];
            saveDataToR2().then(() => {
                updateStats();
                renderManageProducts();
                clearForm();
                showStatus('äº§å“å·²åˆ é™¤', 'success', 'manageFormStatus');
                checkStorageStatus();
            });
        }

        function clearForm() {
            document.getElementById('manageForm').reset();
            document.getElementById('imageInput').value = '';
            document.getElementById('bulkImageInput').value = '';
            editingCode = null;
            document.getElementById('addBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            showStatus('è¡¨å•å·²æ¸…ç©º', 'loading', 'manageFormStatus');
            document.getElementById('manageFormStatus').style.display = 'none';
        }

        function filterManageProducts() {
            manageSearchTerm = document.getElementById('manageSearchInput').value.toUpperCase();
            manageCurrentPage = 1;
            renderManageProducts();
        }

        // ========== ä¼˜åŒ–åçš„äº§å“ç®¡ç†å¡ç‰‡æ¸²æŸ“å‡½æ•° ==========
        function renderManageProducts() {
            // è¿‡æ»¤äº§å“
            filteredManageProducts = Object.keys(catalogData)
                .filter(code => {
                    if (!manageSearchTerm) return true;
                    const product = catalogData[code];
                    return code.toUpperCase().includes(manageSearchTerm) || 
                          (product.supplier && product.supplier.toUpperCase().includes(manageSearchTerm));
                })
                .sort();
            
            // è®¡ç®—åˆ†é¡µ
            const startIndex = (manageCurrentPage - 1) * managePageSize;
            const endIndex = startIndex + managePageSize;
            const productsToShow = filteredManageProducts.slice(0, endIndex);
            hasMoreProducts = endIndex < filteredManageProducts.length;
            
            var list = document.getElementById('manageProductList');
            var html = '';
            
            if (productsToShow.length === 0) {
                html = '<div class="empty-state" style="padding: 2rem; background: white; border-radius: 12px; text-align: center;"><div class="empty-icon" style="font-size:3rem; color: #ccc;">ğŸ“¦</div><div class="empty-text" style="font-size:1.1rem;">æš‚æ— äº§å“</div><div class="empty-subtext">é€šè¿‡ä¸Šæ–¹è¡¨å•æ·»åŠ æˆ–ä¸Šä¼ æ–‡ä»¶å¯¼å…¥</div></div>';
            } else {
                productsToShow.forEach(function(code) {
                    var product = catalogData[code];
                    
                    html += '<div class="manage-product-card">';
                
                    html += '<div class="manage-product-content">';
                    html += '<div class="manage-product-header">';
                    html += '<div class="manage-product-code">ğŸ“¦ ' + code + '</div>';
                    html += '</div>';
                    
                    html += '<div class="manage-specs-grid">';
                    html += '<div class="manage-spec-item"><label>ğŸ’° ç ä»·</label><div class="value">' + product.price + '</div></div>';
                    html += '<div class="manage-spec-item"><label>ğŸ’° ç±³ä»·</label><div class="value">' + product.priceAlt + '</div></div>';
                    html += '<div class="manage-spec-item"><label>ğŸ“ é—¨å¹…</label><div class="value">' + product.width + '</div></div>';
                    html += '<div class="manage-spec-item"><label>âš–ï¸ å…‹é‡</label><div class="value">' + product.weight + '</div></div>';
                    
                    html += '<div class="manage-product-full-row">';
                    html += '<label>ğŸ§µ æˆåˆ†</label>';
                    html += '<div class="value">' + product.composition + '</div>';
                    html += '</div>';
                    
                    html += '<div class="manage-product-full-row">';
                    html += '<label>ğŸ­ ä¾›åº”å•†</label>';
                    html += '<div class="value">' + product.supplier + '</div>';
                    html += '</div>';

                    html += '</div>';
                    
                    if (product.notes && product.notes !== '-') {
                        html += '<div class="manage-product-notes">' + product.notes + '</div>';
                    }
                    
                    html += '</div>';

                    html += '<div class="manage-product-footer">';
                    html += '<div class="manage-product-image-container">';
                    if (product.image) {
                        html += '<img src="' + product.image + '" alt="åº•å¡" class="manage-product-image" data-code="' + code + '">';
                    } else {
                        html += '<div class="manage-product-image" style="display:flex; align-items:center; justify-content:center; background:#eee; color:#aaa; font-size:0.7rem; text-align:center;"><span>æ— å›¾ç‰‡</span></div>';
                    }
                    html += '</div>';
                    html += '<div class="manage-product-actions">';
                    html += '<button class="btn-edit" onclick="editProduct(\'' + code + '\')">ç¼–è¾‘</button>';
                    html += '<button class="btn-remove" onclick="deleteProductFromList(\'' + code + '\')">åˆ é™¤</button>';
                    html += '</div>';
                    html += '</div>';

                    html += '</div>';
                });
            }
            
            list.innerHTML = html;
            
            // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (hasMoreProducts) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
            
            bindImageEvents();
        }

        function loadMoreProducts() {
            manageCurrentPage++;
            renderManageProducts();
        }

        function deleteProductFromList(code) {
            if (confirm('ç¡®å®šåˆ é™¤äº§å“ ' + code + 'ï¼Ÿ')) {
                delete catalogData[code];
                saveDataToR2().then(() => {
                    updateStats();
                    renderManageProducts();
                    showStatus('äº§å“å·²åˆ é™¤', 'success', 'manageFormStatus');
                    checkStorageStatus();
                });
            }
        }

        // --- æ•°æ®ä¸Šä¼ ä¸å¤‡ä»½æ¨¡å— ---
        function exportAndUploadBackup() {
            if (Object.keys(catalogData).length === 0) {
                showStatus('æ— æ•°æ®å¯å¯¼å‡º', 'error', 'dataStatusMsg');
                return;
            }
           
            showStatus('æ­£åœ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶...', 'loading', 'dataStatusMsg');
           
            var zip = new JSZip();
            var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
           
            var fullData = {
                catalogData: catalogData,
                uploadedFiles: uploadedFiles,
                searchHistory: searchHistory,
                exportTime: new Date().toISOString(),
                version: '4.0-r2'
            };
           
            zip.file('database.json', JSON.stringify(fullData, null, 2));
           
            try {
                var rows = [['äº§å“ä»£ç ', 'ç ä»·', 'ç±³ä»·', 'é—¨å¹…', 'æˆåˆ†', 'å…‹é‡', 'å¤‡æ³¨', 'ä¾›åº”å•†']];
                Object.values(catalogData).forEach(function(p) {
                    rows.push([
                        p.code || '-',
                        p.price || '-',
                        p.priceAlt || '-',
                        p.width || '-',
                        p.composition || '-',
                        p.weight || '-',
                        p.notes || '-',
                        p.supplier || '-'
                    ]);
                });
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.aoa_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, 'äº§å“æ•°æ®');
                var xlsxBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                zip.file('äº§å“æ•°æ®è¡¨.xlsx', xlsxBuffer);
            } catch (xlsxError) {
                console.error('XLSX generation error:', xlsxError);
            }
           
            zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            }).then(async function(content) {
                // ä¸‹è½½åˆ°æœ¬åœ°
                var link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'å®‡ä¸œçººç»‡å…¨åº“å¤‡ä»½_' + timestamp + '.zip';
                link.click();
                URL.revokeObjectURL(link.href);
                
                // ä¸Šä¼ åˆ°Cloudflare R2
                try {
                    await uploadBackupToR2(content, link.download);
                    showStatus('âœ… å®Œæ•´å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼å·²åŒæ­¥åˆ°Cloudflare R2ã€‚', 'success', 'dataStatusMsg');
                } catch (error) {
                    console.error('å¤‡ä»½ä¸Šä¼ å¤±è´¥:', error);
                    showStatus('âœ… å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼Œä½†ä¸Šä¼ åˆ°R2å¤±è´¥: ' + error.message, 'warning', 'dataStatusMsg');
                }
            }).catch(function(error) {
                console.error('ZIP generation error:', error);
                showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error', 'dataStatusMsg');
            });
        }

        function importDatabase(files) {
            if (files.length === 0) return;
            var file = files[0];
           
            showStatus('æ­£åœ¨å¯¼å…¥æ•°æ®åº“...', 'loading', 'dataStatusMsg');
           
            if (file.name.endsWith('.json')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = JSON.parse(e.target.result);
                        if (data.catalogData) {
                            catalogData = data.catalogData;
                            uploadedFiles = data.uploadedFiles || [];
                            searchHistory = data.searchHistory || [];
                        } else {
                            catalogData = data;
                        }
                        saveDataToR2().then(() => {
                            updateStats();
                            renderFilesList();
                            renderManageProducts();
                            renderResults();
                            renderHistory();
                            showStatus('âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼', 'success', 'dataStatusMsg');
                            checkStorageStatus();
                        });
                    } catch (err) {
                        console.error('JSON parse error:', err);
                        showStatus('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼é”™è¯¯ - ' + err.message, 'error', 'dataStatusMsg');
                    }
                };
                reader.onerror = function() { showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error', 'dataStatusMsg'); };
                reader.readAsText(file);
               
            } else if (file.name.endsWith('.zip')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    JSZip.loadAsync(e.target.result).then(function(zip) {
                        var jsonFile = zip.file('database.json') || zip.file('æ•°æ®åº“å¤‡ä»½.json');
                       
                        if (jsonFile) {
                            jsonFile.async('string').then(function(jsonStr) {
                                try {
                                    var data = JSON.parse(jsonStr);
                                    if (data.catalogData) {
                                        catalogData = data.catalogData;
                                        uploadedFiles = data.uploadedFiles || [];
                                        searchHistory = data.searchHistory || [];
                                    } else {
                                        catalogData = data;
                                    }
                                    saveDataToR2().then(() => {
                                        updateStats();
                                        renderFilesList();
                                        renderManageProducts();
                                        renderResults();
                                        renderHistory();
                                        showStatus('âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼å…± ' + Object.keys(catalogData).length + ' æ¡æ•°æ®', 'success', 'dataStatusMsg');
                                        checkStorageStatus();
                                    });
                                } catch (err) {
                                    console.error('JSON parse error:', err);
                                    showStatus('å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼é”™è¯¯', 'error', 'dataStatusMsg');
                                }
                            }).catch(function(err) {
                                console.error('JSON read error:', err);
                                showStatus('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è¯»å–JSONæ–‡ä»¶', 'error', 'dataStatusMsg');
                            });
                        } else {
                            showStatus('å¯¼å…¥å¤±è´¥ï¼šZIPä¸­æœªæ‰¾åˆ°database.jsonæˆ–æ•°æ®åº“å¤‡ä»½.json', 'error', 'dataStatusMsg');
                        }
                    }).catch(function(err) {
                        console.error('ZIP parse error:', err);
                        showStatus('å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„ZIPæ–‡ä»¶ - ' + err.message, 'error', 'dataStatusMsg');
                    });
                };
                reader.onerror = function() { showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error', 'dataStatusMsg'); };
                reader.readAsArrayBuffer(file);
            } else {
                showStatus('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼ .jsonæˆ–.zipæ–‡ä»¶', 'error', 'dataStatusMsg');
            }
        }

        document.getElementById('localDbInput').addEventListener('change', function(e) {
            importDatabase(e.target.files);
            e.target.value = '';
        });

        function clearData() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶å’Œäº§å“æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼')) {
                catalogData = {};
                uploadedFiles = [];
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
               
                saveDataToR2().then(() => {
                    updateStats();
                    renderFilesList();
                    renderResults();
                    renderManageProducts();
                    showStatus('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success', 'dataStatusMsg');
                    checkStorageStatus();
                });
            }
        }

        function renderFilesList() {
            var filesDiv = document.getElementById('filesList');
            if (uploadedFiles.length === 0) {
                filesDiv.innerHTML = '<div class="empty-state" style="text-align: center; padding: 1rem;"><div class="empty-icon" style="font-size:2rem; color: #ccc;">ğŸ“</div><div class="empty-subtext">æš‚æ— æ–‡ä»¶è®°å½•</div></div>';
                return;
            }
            var html = '';
            uploadedFiles.forEach(function(f) {
                html += '<div class="file-item"><div class="file-name">ğŸ“„ ' + f.name + '</div><div class="file-info">' + f.uploadTime + ' Â· ' + f.count + ' æ¡</div></div>';
            });
            filesDiv.innerHTML = html;
        }
        
        // ========== æ··åˆå­˜å‚¨ç­–ç•¥ï¼šæ‰¹é‡ä¸Šä¼ å›¾ç‰‡ ==========
        document.getElementById('bulkImageInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // æ£€æŸ¥æ˜¯å¦é…ç½®äº†R2
            const hasR2Config = r2Config.accessKey && r2Config.secretKey && s3Client;
            
            if (!hasR2Config) {
                showStatus('è¯·å…ˆé…ç½®Cloudflare R2', 'error', 'manageFormStatus');
                return;
            }
            
            showStatus(`å¤„ç† ${files.length} å¼ å›¾ç‰‡...`, 'loading', 'manageFormStatus');
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            document.getElementById('bulkImageUploadProgress').style.display = 'block';
            document.getElementById('bulkImageUploadProgressFill').style.width = '0%';
            
            let success = 0, fail = 0;
            let failedFiles = [];
            let processed = 0;
            
            // ä¸²è¡Œå¤„ç†æ¯ä¸ªæ–‡ä»¶ï¼Œé¿å…å¹¶å‘é—®é¢˜
            for (const file of files) {
                const name = file.name.toUpperCase();
                
                // ä¿®å¤ï¼šæ›´çµæ´»çš„æ–‡ä»¶åè§£æï¼Œæ”¯æŒå„ç§å¸¸è§çš„å›¾ç‰‡æ‰©å±•å
                const code = name.replace(/\.(JPG|PNG|JPEG|GIF|BMP|WEBP|SVG)$/i, '').trim();
                
                if (!code) {
                    fail++;
                    failedFiles.push({ name: file.name, error: 'æ–‡ä»¶åæ— æ³•æå–äº§å“ä»£ç ' });
                    processed++;
                    updateBulkProgress(processed, files.length, success, fail);
                    continue;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    fail++;
                    failedFiles.push({ name: file.name, error: 'æ–‡ä»¶å¤§äº5MB' });
                    processed++;
                    updateBulkProgress(processed, files.length, success, fail);
                    continue;
                }
                
                if (!catalogData[code]) {
                    fail++;
                    failedFiles.push({ name: file.name, error: 'äº§å“ä»£ç ä¸å­˜åœ¨' });
                    processed++;
                    updateBulkProgress(processed, files.length, success, fail);
                    continue;
                }
                
                try {
                    // ä¸Šä¼ åˆ°R2
                    const imageUrl = await uploadToR2(file, code);
                    catalogData[code].image = imageUrl;
                    success++;
                } catch (error) {
                    fail++;
                    failedFiles.push({ name: file.name, error: error.message || 'ä¸Šä¼ å¤±è´¥' });
                }
                
                processed++;
                updateBulkProgress(processed, files.length, success, fail);
            }
            
            // å…¨éƒ¨å¤„ç†å®Œæˆåï¼Œä¿å­˜æ•°æ®
            await saveDataToR2();
            document.getElementById('bulkImageUploadProgress').style.display = 'none';
            
            let statusMsg = `æ‰¹é‡ä¸Šä¼ å®Œæˆï¼š${success} æˆåŠŸï¼Œ${fail} å¤±è´¥`;
            
            if (failedFiles.length > 0) {
                // æ˜¾ç¤ºå‰5ä¸ªå¤±è´¥çš„æ–‡ä»¶
                const failedList = failedFiles.slice(0, 5).map(f => `${f.name} (${f.error})`).join('; ');
                statusMsg += `ã€‚å¤±è´¥æ–‡ä»¶ï¼š${failedList}${failedFiles.length > 5 ? '...' : ''}`;
            }
            
            showStatus(statusMsg, fail > 0 ? 'error' : 'success', 'manageFormStatus');
            renderManageProducts();
            checkStorageStatus();
            e.target.value = '';
        });
        
        function updateBulkProgress(processed, total, success, fail) {
            const progress = Math.round(processed / total * 100);
            document.getElementById('bulkImageUploadProgressFill').style.width = progress + '%';
            showStatus(`æ‰¹é‡ä¸Šä¼ è¿›åº¦: ${progress}% (æˆåŠŸ: ${success}, å¤±è´¥: ${fail})`, 'loading', 'manageFormStatus');
        }

        // --- PDF å¯¼å‡º ---
        function exportQuotePDF() {
            var allResults = [];
            if (rangeResults.length > 0) {
                rangeResults.forEach(function(range) { range.matches.forEach(function(product) { allResults.push(product); }); });
            } else {
                searchResults.filter(function(r) { return r.found; }).forEach(function(r) { allResults.push(r); });
            }
            if (allResults.length === 0) {
                showStatus('æ— ç»“æœå¯å¯¼å‡º', 'error', 'dataStatusMsg');
                return;
            }
           
            showStatus('æ­£åœ¨ç”ŸæˆæŠ¥ä»·PDF...', 'loading', 'dataStatusMsg');
            
            var printContainer = document.createElement('div');
            printContainer.id = 'pdf-content';
            printContainer.style.cssText = 'position: absolute; left: -9999px; width: 250mm; font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif; background: white; padding: 15mm; line-height: 1.1;';
            document.body.appendChild(printContainer);
           
            var html = '<h1 style="text-align: center; color: var(--za-green-dark); font-size: 16pt; margin-bottom: 8mm; border-bottom: 2px solid var(--za-green-dark); padding-bottom: 4mm;">ğŸ“Š å®‡ä¸œçººç»‡æŠ¥ä»·å•</h1>';
            html += '<div style="text-align: center; color: #666; margin-bottom: 6mm; font-size: 8pt;">ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN') + ' | äº§å“æ•°é‡ï¼š' + allResults.length + ' é¡¹</div>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 4mm; page-break-inside: auto; font-size: 7pt;">';
            html += '<thead><tr style="page-break-inside: avoid; page-break-after: auto;">';
            html += '<th style="width: 6%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">åºå·</th>';
            html += '<th style="width: 14%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">äº§å“ä»£ç </th>';
            html += '<th style="width: 9%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">ç ä»·</th>';
            html += '<th style="width: 9%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">ç±³ä»·</th>';
            html += '<th style="width: 9%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">é—¨å¹…</th>';
            html += '<th style="width: 14%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">æˆåˆ†</th>';
            html += '<th style="width: 9%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">å…‹é‡</th>';
            html += '<th style="width: 20%; background-color: var(--za-green-dark); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">å¤‡æ³¨</th>';
            html += '</tr></thead><tbody>';
           
            allResults.forEach(function(product, index) {
                html += '<tr style="page-break-inside: avoid; page-break-after: auto; height: auto; min-height: 12pt;">';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + (index + 1) + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;"><strong>' + product.code + '</strong></td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.price + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.priceAlt + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.width + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle; word-wrap: break-word;">' + product.composition + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.weight + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: left; border: 1px solid #ddd; font-size: 6pt; vertical-align: top; color: #d32f2f; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; line-height: 1.2; hyphens: auto; display: block;">' + (product.notes && product.notes !== '-' ? product.notes : '') + '</td>';
                html += '</tr>';
            });
           
            html += '</tbody></table>';
            html += '<div style="text-align: center; color: #999; font-size: 6pt; margin-top: 8mm; border-top: 1px solid #ddd; padding-top: 4mm;">æœ¬æŠ¥ä»·å•ç”±å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿç”Ÿæˆ | ç³»ç»Ÿç‰ˆæœ¬ï¼šv4.0-R2</div>';
            printContainer.innerHTML = html;
           
            html2canvas(printContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: printContainer.scrollWidth,
                height: printContainer.scrollHeight,
                logging: false
            }).then(function(canvas) {
                var { jsPDF } = window.jspdf;
                var pdf = new jsPDF('l', 'mm', 'a4');
                var pdfWidth = pdf.internal.pageSize.getWidth();
                var pdfHeight = pdf.internal.pageSize.getHeight();
                var imgWidth = pdfWidth - 30;
                var pageHeight = pdfHeight - 30;
                var imgHeight = (canvas.height * imgWidth) / canvas.width;
                var heightLeft = imgHeight;
                var position = 15;
               
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 15, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
               
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 15;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 15, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
               
                pdf.save('æŠ¥ä»·å•_' + new Date().toISOString().slice(0, 10) + '.pdf');
                showStatus('âœ… PDFç”ŸæˆæˆåŠŸï¼', 'success', 'dataStatusMsg');
                document.body.removeChild(printContainer);
            }).catch(function(error) {
                console.error('PDF generation error:', error);
                showStatus('PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error', 'dataStatusMsg');
                document.body.removeChild(printContainer);
            });
        }

        // ============== å…¨å±€äº‹ä»¶ç›‘å¬ ==============
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.key === 'Esc') {
                if (document.getElementById('imageModal').classList.contains('active')) {
                    closeImageModal();
                }
            }
        });

        // ============== åº”ç”¨åˆå§‹åŒ– ==============
        async function initApp() {
            // åˆå§‹åŒ–R2é…ç½®
            loadR2Config();
            
            // å¦‚æœR2å·²é…ç½®ï¼Œä»R2åŠ è½½æ•°æ®ï¼Œå¦åˆ™ä½¿ç”¨ç©ºæ•°æ®
            if (s3Client) {
                await loadDataFromR2();
            } else {
                catalogData = {};
                uploadedFiles = [];
                searchHistory = [];
            }
            
            renderHistory();
            updateStats();
            bindImageEvents();
            checkStorageStatus();
            switchTab('query');
        }
        initApp();
    </script>
</body>
</html>