<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="å®‡ä¸œæŠ¥ä»·">
    <title>å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿ - èˆ’é€‚è«å…°è¿ªç‰ˆ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- AWS S3 SDK (å…¼å®¹Cloudflare R2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1462.0/aws-sdk.min.js"></script>

    <!-- PhotoSwipe å›¾ç‰‡æŸ¥çœ‹å™¨ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/photoswipe.min.css">
    
    <style>
        /* =========================================
           ğŸ¨ â€œæ™¨é›¾ä¸æš–èŒ¶â€ é…è‰²ç³»ç»Ÿ - ä¸¥æ ¼éµå¾ªå‚è€ƒè®¾è®¡
           ========================================= */
        :root {
            /* --- æ ¸å¿ƒè°ƒè‰²ç›˜ --- */
            --color-sage: #8DA399;          /* é¼ å°¾è‰ç»¿ï¼šä¸»è‰²ï¼Œå®é™è‡´è¿œ */
            --color-sand: #E6DCD3;          /* æš–æ²™è‰²ï¼šè¾…åŠ©èƒŒæ™¯ */
            --color-oatmeal: #F7F5F2;       /* ç‡•éº¦è‰²ï¼šé¡µé¢å¤§èƒŒæ™¯ */
            --color-clay: #DABFAB;          /* é™¶åœŸè‰²ï¼šæ¸©æš–çš„ç‚¹ç¼€ */
            
            /* --- æ–‡å­—è‰² --- */
            --text-primary: #5D6660;        /* æ·±ç°ç»¿ï¼šæ­£æ–‡ï¼Œæ¯”çº¯é»‘æŸ”å’Œ */
            --text-secondary: #9CA6A0;      /* æµ…ç°ç»¿ï¼šæ¬¡è¦ä¿¡æ¯ */
            --text-price: #B58D7A;          /* æ¯ç«ç‘°è‰²ï¼šä»·æ ¼ä¸“ç”¨ */
            
            /* --- ç•Œé¢ç»„ä»¶ --- */
            --card-bg: #FFFFFF;             /* å¡ç‰‡èƒŒæ™¯ */
            --radius-lg: 24px;              /* å¤§åœ†è§’ */
            --radius-pill: 50px;            /* èƒ¶å›Šåœ†è§’ */
            
            /* --- æå…¶ç»†è…»çš„é˜´å½± --- */
            --shadow-soft: 0 10px 40px -10px rgba(141, 163, 153, 0.15);
            --shadow-inset: inset 0 2px 4px 0 rgba(0,0,0, 0.02);
            
            /* é—´è· */
            --spacing: 1.25rem;
            --transition: all 0.3s ease;
        }

        /* =========================================
           åŸºç¡€æ’ç‰ˆ - éµå¾ªå‚è€ƒè®¾è®¡
           ========================================= */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--color-oatmeal);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }

        .container {
            width: 100%;
            max-width: 760px; /* å‚è€ƒè®¾è®¡çš„ç²¾è‡´å®½åº¦ */
            margin: 0 auto;
            padding: 0 20px;
            /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶å‡ºç°ç™½å± */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        /* =========================================
           1. Header: æç®€çº¯å‡€ - é‡æ–°è®¾è®¡
           ========================================= */
        .header-section {
            padding: 3rem 1rem 2rem;
            text-align: center;
            background: transparent;
            box-shadow: none;
            border-radius: 0;
            margin-bottom: 0;
            color: var(--text-primary);
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
        }

        .app-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: 1px;
            margin-bottom: 0;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ - èƒ¶å›Šé£æ ¼ */
        .status-pills {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .status-pill {
            background: #fff;
            padding: 0.5rem 1.2rem;
            border-radius: var(--radius-pill);
            font-size: 0.75rem;
            color: var(--text-secondary);
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--color-sage);
        }

        /* =========================================
           2. å¯¼èˆªæ : æ¼‚æµ®ä¸èåˆ - é‡æ–°è®¾è®¡
           ========================================= */
        .nav-wrapper {
            position: sticky;
            top: 20px;
            z-index: 100;
            margin-bottom: 2.5rem;
        }

        .tab-bar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-pill);
            padding: 6px;
            display: flex;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255,255,255,0.5);
            margin: 0;
        }

        .tab-button {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            border-radius: var(--radius-pill);
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-weight: 500;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-button.active {
            background-color: var(--color-sage);
            color: #fff;
            box-shadow: 0 4px 12px rgba(141, 163, 153, 0.4);
        }

        /* =========================================
           3. æœç´¢åŒºåŸŸ: äº²å’ŒåŠ› - é‡æ–°è®¾è®¡
           ========================================= */
        .search-box {
            position: relative;
            margin-bottom: 2.5rem;
            transition: transform 0.2s;
        }

        .search-box:focus-within {
            transform: scale(1.01);
        }

        .search-input {
            width: 100%;
            padding: 1.2rem 1.5rem 1.2rem 3.5rem;
            border: none;
            border-radius: var(--radius-lg);
            background: var(--card-bg);
            font-size: 1rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
            outline: none;
            resize: vertical;
            min-height: 5rem;
            font-family: inherit;
        }
        
        .search-input::placeholder {
            color: #C8D1CD;
        }

        .search-icon {
            position: absolute;
            left: 1.2rem;
            top: 1.2rem;
            color: var(--color-sage);
            opacity: 0.7;
            width: 1.25rem;
            height: 1.25rem;
        }

        /* æ ‡ç­¾äº‘ */
        .search-history {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding: 0 0.5rem;
        }

        .history-item {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0.4rem 1rem;
            background: rgba(255,255,255,0.6);
            border-radius: var(--radius-pill);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #fff;
            color: var(--color-sage);
            border-color: var(--color-sage);
        }

        /* =========================================
           4. ä¸»å†…å®¹åŒºåŸŸ
           ========================================= */
        .main-content {
            padding: 0;
        }

        .tab-content {
            display: none;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           5. æ¨¡å—æ ‡é¢˜ - é‡æ–°è®¾è®¡
           ========================================= */
        .module-title {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            padding-left: 0.5rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: none;
            padding-bottom: 0;
        }
        .module-title::after {
            content: "";
            height: 1px;
            background: var(--color-sand);
            flex: 1;
            opacity: 0.5;
        }

        /* =========================================
           6. å¡ç‰‡è®¾è®¡: æ‚å¿—æ’ç‰ˆæ„Ÿ - é‡æ–°è®¾è®¡
           ========================================= */
        .product-card, .upload-card, .r2-config {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 1.8rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.8);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card:hover, .upload-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px -10px rgba(141, 163, 153, 0.25);
        }

        /* è£…é¥°æ€§èƒŒæ™¯åœ† - å¢åŠ è‰ºæœ¯æ„Ÿ */
        .product-card::before, .upload-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--color-oatmeal);
            opacity: 0.5;
            z-index: 0;
        }

        .product-content, .upload-card > * {
            position: relative;
            z-index: 1;
        }

        /* äº§å“å¤´éƒ¨ */
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            background: transparent;
            border-bottom: none;
            padding: 0;
        }

        .code-block {
            display: flex;
            flex-direction: column;
        }

        .code-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .product-code {
            font-family: "Georgia", serif;
            font-size: 1.6rem;
            color: var(--text-primary);
            font-weight: normal;
        }

        .match-badge {
            background: var(--color-oatmeal);
            color: var(--color-sage);
            font-size: 0.7rem;
            padding: 0.3rem 0.8rem;
            border-radius: var(--radius-pill);
            font-weight: 600;
        }

        /* æ•°æ®ç½‘æ ¼ */
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .spec-item {
            display: flex;
            flex-direction: column;
        }

        .spec-item label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }

        .spec-item .value {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* ä»·æ ¼ç‰¹æ®Šæ ·å¼ */
        .price-highlight {
            color: var(--text-price);
            font-family: "Georgia", serif;
            font-size: 1.3rem;
            font-style: italic;
        }

        /* ä¾›åº”å•†å’Œå›¾ç‰‡é“¾æ¥ */
        .supplier-box {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--color-sand);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            padding: 0.75rem 0 0 0;
            border-radius: 0;
        }

        .supplier-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .supplier-icon {
            width: 24px;
            height: 24px;
            background: var(--color-oatmeal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .view-image-link {
            color: var(--color-sage);
            text-decoration: none;
            font-size: 0.85rem;
            border-bottom: 1px solid transparent;
            transition: border 0.2s;
            cursor: pointer;
        }
        .view-image-link:hover {
            border-bottom-color: var(--color-sage);
        }

        /* =========================================
           7. æŒ‰é’®è®¾è®¡ - é‡æ–°è®¾è®¡
           ========================================= */
        .za-btn {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex-grow: 1;
            min-width: 120px;
            font-size: 1rem;
            font-family: inherit;
            /* é˜²æ­¢ç§»åŠ¨ç«¯ç‚¹å‡»é—ªçƒ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .za-btn:active {
            transform: translateY(1px);
        }

        .za-btn-primary {
            background: var(--color-sage);
            color: white;
            box-shadow: 0 4px 15px rgba(141, 163, 153, 0.3);
        }

        .za-btn-secondary {
            background: var(--color-sand);
            color: var(--text-primary);
        }

        .za-btn-success { 
            background: #A5D6A7; 
            color: white; 
            box-shadow: 0 4px 15px rgba(165, 214, 167, 0.3);
        }
        .za-btn-error { 
            background: #EF9A9A; 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 154, 154, 0.3);
        }
        .za-btn-warning { 
            background: #FFCC80; 
            color: var(--text-primary); 
            box-shadow: 0 4px 15px rgba(255, 204, 128, 0.3);
        }

        .button-row {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* =========================================
           8. è¡¨å•å…ƒç´  - é‡æ–°è®¾è®¡
           ========================================= */
        .manage-input, .manage-search, .manage-file-input {
            width: 100%;
            padding: 1rem 1.2rem;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--card-bg);
            transition: var(--transition);
            font-family: inherit;
            box-shadow: var(--shadow-soft);
        }

        .manage-input:focus, .manage-search:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--color-sage), var(--shadow-soft);
        }

        .manage-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .manage-input-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            display: block;
        }

        /* =========================================
           9. æç¤ºæ–‡æœ¬ - é‡æ–°è®¾è®¡
           ========================================= */
        .hint-text {
            background: var(--color-oatmeal);
            padding: 1rem;
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            border-left: 3px solid var(--color-sage);
        }

        .hint-text.hint-error {
            background: #FDE8E8;
            color: color-mix(in srgb, #EF9A9A 80%, black);
            border-left-color: #EF9A9A;
        }

        /* =========================================
           10. ç®¡ç†äº§å“å¡ç‰‡ - é‡æ–°è®¾è®¡
           ========================================= */
        .manage-product-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
        }

        .manage-product-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--color-oatmeal);
            opacity: 0.5;
            z-index: 0;
        }

        .manage-product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px -10px rgba(141, 163, 153, 0.25);
        }

        .manage-product-header {
            background: transparent;
            padding: 1.5rem 1.5rem 0;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .manage-product-code {
            font-family: "Georgia", serif;
            font-size: 1.6rem;
            color: var(--text-primary);
            font-weight: normal;
        }

        .manage-product-content {
            padding: 1rem 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .manage-specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            flex: 1;
        }

        .manage-spec-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            text-align: left;
            padding: 0.5rem 0;
        }

        .manage-spec-item label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .manage-spec-item .value {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-word;
        }

        .manage-product-full-row {
            grid-column: 1 / -1;
            text-align: left;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            border-top: 1px dashed var(--color-sand);
            padding-top: 0.75rem;
        }

        .manage-product-notes {
            font-size: 0.875rem;
            color: var(--text-price);
            font-weight: 600;
            background: var(--color-oatmeal);
            padding: 0.75rem;
            border-radius: 12px;
            word-break: break-word;
            line-height: 1.4;
            position: relative;
            overflow: hidden;
            margin-top: 0.5rem;
            border-left: 3px solid var(--text-price);
        }

        .manage-product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--color-oatmeal);
            border-top: 1px solid var(--color-sand);
            position: relative;
            z-index: 1;
        }

        .manage-product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid var(--color-sand);
            cursor: pointer;
            background-color: var(--color-oatmeal);
            transition: var(--transition);
        }

        .manage-product-image:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-soft);
        }

        .btn-edit, .btn-remove {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            min-width: 70px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-edit { 
            background: var(--color-sage); 
            color: white; 
            box-shadow: 0 2px 8px rgba(141, 163, 153, 0.3);
        }
        .btn-remove { 
            background: #EF9A9A; 
            color: white; 
            box-shadow: 0 2px 8px rgba(239, 154, 154, 0.3);
        }

        /* =========================================
           11. å“åº”å¼è°ƒæ•´
           ========================================= */
        @media (max-width: 600px) {
            .container {
                padding: 0 15px;
            }
            
            .header-section {
                padding: 2rem 1rem 1.5rem;
            }
            
            .app-title {
                font-size: 1.3rem;
            }
            
            .status-pills {
                gap: 0.5rem;
            }
            
            .status-pill {
                padding: 0.4rem 1rem;
                font-size: 0.7rem;
            }
            
            .nav-wrapper {
                margin-bottom: 2rem;
            }
            
            .tab-button {
                font-size: 0.8rem;
                padding: 8px 0;
            }
            
            .search-input {
                padding: 1rem 1.2rem 1rem 3rem;
                min-height: 4rem;
            }
            
            .search-icon {
                left: 1rem;
                top: 1rem;
            }
            
            .product-card, .upload-card, .r2-config {
                padding: 1.5rem;
            }
            
            .manage-form {
                grid-template-columns: 1fr;
            }
            
            .za-btn {
                min-width: 100%;
                padding: 0.875rem 1rem;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .specs-grid, .manage-specs-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .manage-product-footer {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .manage-product-image-container {
                justify-content: center;
            }
            
            .manage-product-actions {
                justify-content: center;
            }
        }

        @media (min-width: 601px) {
            .manage-product-card {
                flex-direction: row;
            }
            
            .manage-product-content {
                flex: 1;
                min-width: 0;
            }
            
            .manage-product-footer {
                flex-direction: column;
                justify-content: space-between;
                width: 140px;
                flex-shrink: 0;
                border-top: none;
                border-left: 1px solid var(--color-sand);
            }
        }

        /* =========================================
           12. å…¶ä»–ç»„ä»¶æ ·å¼è°ƒæ•´
           ========================================= */
        .storage-status-bar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .storage-status-badge {
            padding: 0.4rem 1rem;
            border-radius: var(--radius-pill);
            font-size: 0.7rem;
            font-weight: 600;
            background: rgba(255,255,255,0.8);
            color: var(--text-secondary);
        }

        .storage-local {
            border: 1px solid #FFCC80;
            color: var(--text-primary);
        }

        .storage-r2 {
            border: 1px solid var(--color-sage);
            color: var(--text-primary);
        }

        .files-list-container, .manage-product-list, .r2-backup-list {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            background: var(--card-bg);
            box-shadow: var(--shadow-soft);
            padding: 1rem;
        }

        .file-item, .r2-backup-item {
            background: var(--color-oatmeal);
            padding: 0.75rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            transition: var(--transition);
            border-left: 3px solid var(--color-sage);
        }

        .file-item:hover, .r2-backup-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-soft);
        }

        .status-msg {
            margin-top: 0.75rem;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
            border-left: 3px solid;
        }
        
        .status-success { 
            background: #E6F7E9; 
            color: #5D6660; 
            border-left-color: #A5D6A7;
        }
        .status-error { 
            background: #FDE8E8; 
            color: #5D6660; 
            border-left-color: #EF9A9A;
        }
        .status-loading { 
            background: #EFF6FF; 
            color: #5D6660; 
            border-left-color: var(--color-sage);
        }

        .image-upload-single, .image-upload-batch {
            background: var(--color-oatmeal);
            border: 2px dashed var(--color-sage);
            padding: 1rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
        }

        .image-upload-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨ Header -->
        <div class="header-section">
            <div class="app-title">YUDONG TEXTILE</div>
            <p class="app-subtitle">Simple & Natural Quote System</p>
            <div class="status-pills">
                <div class="status-pill">
                    <span class="dot"></span>
                    <span id="storageSyncStatus">åŒæ­¥ä¸­...</span>
                </div>
                <div class="status-pill">
                    <span id="dataCount">0</span> æ¬¾é¢æ–™
                </div>
                <div class="status-pill">
                    <span id="systemHealth">0%</span> å¥åº·åº¦
                </div>
            </div>
            <div class="storage-status-bar">
                <div class="storage-status-badge storage-local" id="localStorageBadge">æœ¬åœ°: 0</div>
                <div class="storage-status-badge storage-r2" id="r2StorageBadge">R2: 0</div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆªæ  -->
        <div class="nav-wrapper">
            <nav class="tab-bar">
                <button class="tab-button active" id="tabQueryBtn" onclick="switchTab('query')">
                    <span>ğŸ”</span> æŸ¥è¯¢æŠ¥ä»·
                </button>
                <button class="tab-button" id="tabManageBtn" onclick="switchTab('manage')">
                    <span>ğŸ› ï¸</span> äº§å“ç®¡ç†
                </button>
                <button class="tab-button" id="tabDataBtn" onclick="switchTab('data')">
                    <span>ğŸ“¦</span> æ•°æ®å¤‡ä»½
                </button>
            </nav>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- 1. æŸ¥è¯¢æŠ¥ä»·æ¨¡å— -->
            <div class="tab-content active" id="tabQuery">
                <h2 class="module-title">äº§å“æ™ºèƒ½æŸ¥è¯¢</h2>
                <div class="search-box">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <textarea id="searchInput" class="search-input" rows="3" placeholder="è¾“å…¥äº§å“ä»£ç ã€ä¾›åº”å•†æˆ–ä»·æ ¼/å…‹é‡åŒºé—´...&#10;&#10;ç¤ºä¾‹ï¼š&#10;â€¢ äº§å“ä»£ç ï¼šC6001, Y6&#10;â€¢ ä¾›åº”å•†ï¼šæ°¸è”&#10;â€¢ ä»·æ ¼åŒºé—´ï¼š20å…ƒä»¥ä¸Š, 10-15å…ƒ&#10;â€¢ å…‹é‡åŒºé—´ï¼š100å…‹å†…, 150-200å…‹"></textarea>
                </div>
                
                <p class="hint-text">ğŸ’¡ å®æ—¶æ™ºèƒ½æœç´¢å·²å¼€å¯ï¼šè¾“å…¥å³è‡ªåŠ¨åŒ¹é…äº§å“ä»£ç ã€ä¾›åº”å•†ã€ä»·æ ¼/å…‹é‡åŒºé—´ã€‚æ”¯æŒæ‰¹é‡æŸ¥è¯¢ã€æ¨¡ç³Šæœç´¢ä¸å†å²è®°å½•å¿«é€Ÿè°ƒç”¨ã€‚</p>

                <!-- æœç´¢å†å² -->
                <h3 class="module-title">æœç´¢å†å²</h3>
                <div class="search-history" id="searchHistory"></div>

                <div class="button-row">
                    <button class="za-btn za-btn-primary" onclick="exportQuotePDF()" id="quotePDFBtn" style="display: none;">
                        <span>ğŸ“„</span> å¯¼å‡ºæŠ¥ä»·PDF
                    </button>
                    <button class="za-btn za-btn-secondary" onclick="clearSearchHistory()">
                        <span>ğŸ—‘ï¸</span> æ¸…é™¤å†å²
                    </button>
                </div>
                
                <div id="resultsArea" style="margin-top: var(--spacing);"></div>
            </div>

            <!-- 2. äº§å“ç®¡ç†æ¨¡å— -->
            <div class="tab-content" id="tabManage">
                <h2 class="module-title">äº§å“æ•°æ®ç»´æŠ¤</h2>
                
                <!-- å­˜å‚¨çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="storageStatus" class="hint-text hint-error" style="display: none;">
                    <span id="storageStatusText">å­˜å‚¨çŠ¶æ€æ­£å¸¸</span>
                </div>
                
                <div class="upload-card">
                    <h3 class="module-title">â• æ·»åŠ /ç¼–è¾‘äº§å“</h3>
                    <form class="manage-form" id="manageForm">
                        <div class="manage-input-group">
                            <label for="codeInput">äº§å“ä»£ç </label>
                            <input type="text" id="codeInput" class="manage-input" required placeholder="ä¾‹å¦‚ï¼šC6001, YC2001">
                        </div>
                        <div class="manage-input-group">
                            <label for="priceInput">ç ä»·</label>
                            <input type="text" id="priceInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š12.5å…ƒ/ç ">
                        </div>
                        <div class="manage-input-group">
                            <label for="priceAltInput">ç±³ä»·</label>
                            <input type="text" id="priceAltInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š12.5å…ƒ/ç±³-è¶³ç±³">
                        </div>
                        <div class="manage-input-group">
                            <label for="widthInput">é—¨å¹…</label>
                            <input type="text" id="widthInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š150cm">
                        </div>
                        <div class="manage-input-group">
                            <label for="compositionInput">æˆåˆ†</label>
                            <input type="text" id="compositionInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š100é”¦çº¶">
                        </div>
                        <div class="manage-input-group">
                            <label for="weightInput">å…‹é‡</label>
                            <input type="text" id="weightInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼š90å…‹/å¹³æ–¹ï¼ˆgsmï¼‰">
                        </div>
                        <div class="manage-input-group">
                            <label for="notesInput">å¤‡æ³¨</label>
                            <input type="text" id="notesInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼šé¢œè‰²ä»·æ ¼è¯´æ˜ç­‰">
                        </div>
                        <div class="manage-input-group">
                            <label for="supplierInput">ä¾›åº”å•†</label>
                            <input type="text" id="supplierInput" class="manage-input" placeholder="ä¾‹å¦‚ï¼šå‡¯æ³“K5ã€KH86ã€‘">
                        </div>
                        
                        <!-- å•å¼ å›¾ç‰‡ä¸Šä¼  -->
                        <div class="manage-input-group image-upload-single">
                            <label for="imageInput" class="image-upload-label">ğŸ“· åº•å¡å›¾ç‰‡ï¼ˆå•å¼ ï¼‰</label>
                            <input type="file" id="imageInput" class="manage-input" accept="image/*">
                            <div class="progress-bar" id="imageUploadProgress" style="display: none;">
                                <div class="progress-fill" id="imageUploadProgressFill"></div>
                            </div>
                        </div>
                        
                        <!-- æ‰¹é‡å›¾ç‰‡ä¸Šä¼  -->
                        <div class="manage-input-group image-upload-batch">
                            <label for="bulkImageInput" class="image-upload-label">ğŸ“¸ åº•å¡å›¾ç‰‡ï¼ˆæ‰¹é‡ï¼‰</label>
                            <input type="file" id="bulkImageInput" class="manage-input" multiple accept="image/*">
                            <div class="progress-bar" id="bulkImageUploadProgress" style="display: none;">
                                <div class="progress-fill" id="bulkImageUploadProgressFill"></div>
                            </div>
                        </div>
                        
                        <div class="manage-btn-row">
                            <button type="button" class="za-btn za-btn-success" id="addBtn" onclick="addOrUpdateProduct()">æ·»åŠ äº§å“</button>
                            <button type="button" class="za-btn za-btn-primary" id="updateBtn" onclick="addOrUpdateProduct()" style="display: none;">æ›´æ–°äº§å“</button>
                            <button type="button" class="za-btn za-btn-error" id="deleteBtn" onclick="deleteProduct()" style="display: none;">åˆ é™¤äº§å“</button>
                            <button type="button" class="za-btn za-btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                        </div>
                        <div id="manageFormStatus" class="status-msg" style="grid-column: 1 / -1; display: none;"></div>
                    </form>
                </div>
                
                <div class="upload-card" style="margin-top: var(--spacing);">
                    <h3 class="module-title">ğŸ” äº§å“åˆ—è¡¨ä¸æœç´¢</h3>
                    <div class="search-box" style="margin-bottom: 0;">
                        <svg class="search-icon" style="top: 0.8rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="manageSearchInput" class="manage-search" placeholder="æœç´¢äº§å“ä»£ç æˆ–ä¾›åº”å•†..." oninput="filterManageProducts()" style="padding-left: 3rem;">
                    </div>
                    <div class="manage-product-list" id="manageProductList"></div>
                    <div class="load-more-container" id="loadMoreContainer" style="display: none;">
                        <button class="za-btn za-btn-primary" onclick="loadMoreProducts()">åŠ è½½æ›´å¤š</button>
                    </div>
                </div>
            </div>

            <!-- 3. æ•°æ®å¤‡ä»½æ¨¡å— -->
            <div class="tab-content" id="tabData">
                <h2 class="module-title">æ•°æ®å¤‡ä»½</h2>
                
                <div id="dataStatusMsg"></div>
                
                <!-- Cloudflare R2é…ç½®åŒºåŸŸ -->
                <div class="r2-config">
                    <h3 class="module-title">â˜ï¸ Cloudflare R2 + è‡ªå®šä¹‰åŸŸåé…ç½®</h3>
                    <div class="r2-config-grid">
                        <div class="manage-input-group">
                            <label for="r2AccountId">Account ID</label>
                            <input type="text" id="r2AccountId" class="manage-input" placeholder="è¯·è¾“å…¥Cloudflare Account ID">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2AccessKey">Access Key ID</label>
                            <input type="text" id="r2AccessKey" class="manage-input" placeholder="è¯·è¾“å…¥R2 Access Key ID">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2SecretKey">Secret Access Key</label>
                            <input type="password" id="r2SecretKey" class="manage-input" placeholder="è¯·è¾“å…¥R2 Secret Access Key">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2Bucket">Bucket åç§°</label>
                            <input type="text" id="r2Bucket" class="manage-input" placeholder="è¯·è¾“å…¥å­˜å‚¨æ¡¶åç§°">
                        </div>
                        <div class="manage-input-group">
                            <label for="r2CustomDomain">è‡ªå®šä¹‰åŸŸå</label>
                            <input type="text" id="r2CustomDomain" class="manage-input" placeholder="https://img.yudong-textile.top" value="https://img.yudong-textile.top">
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="za-btn za-btn-primary" onclick="saveR2Config()">ä¿å­˜é…ç½®</button>
                        <button class="za-btn za-btn-secondary" onclick="testR2Connection()">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <p class="hint-text" style="margin-top: 1rem; margin-bottom: 0;">
                        ğŸ’¡ é…ç½®è¯´æ˜ï¼šåœ¨Cloudflareæ§åˆ¶å°åˆ›å»ºR2å­˜å‚¨æ¡¶ï¼Œå°†æ‚¨çš„åŸŸå img.yudong-textile.top é€šè¿‡CNAMEè®°å½•æŒ‡å‘R2å­˜å‚¨æ¡¶ã€‚
                    </p>
                </div>
                
                <div class="upload-section">
                    <!-- æ•°æ®ä¸Šä¼ ä¸å¯¼å…¥ -->
                    <div class="upload-card">
                        <h3 class="module-title">ğŸ“¤ æ•°æ®ä¸Šä¼ ä¸å¯¼å…¥</h3>
                        <div class="button-row" style="margin-top: 0;">
                            <input type="file" id="localDbInput" accept=".json,.zip" style="display: none;">
                            <button class="za-btn za-btn-primary" onclick="document.getElementById('localDbInput').click()">
                                <span>ğŸ“‚</span> æœ¬åœ°DBå¯¼å…¥
                            </button>
                            
                            <button class="za-btn za-btn-success" onclick="loadR2BackupFiles()">
                                <span>â˜ï¸</span> Cloudflare R2å¯¼å…¥
                            </button>
                        </div>
                        
                        <!-- R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ -->
                        <div id="r2BackupList" class="r2-backup-list" style="display: none;">
                            <!-- R2å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <p class="hint-text" style="margin-top: 1rem; margin-bottom: 0;">å¯¼å…¥æ•°æ®åº“å°†è¦†ç›–å½“å‰æ‰€æœ‰äº§å“æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
                    </div>

                    <!-- å¤‡ä»½ä¸æ¸…ç©º -->
                    <div class="upload-card">
                        <h3 class="module-title">ğŸ“¥ æ•°æ®å¤‡ä»½ä¸æ¸…ç©º</h3>
                        <div class="button-row" style="margin-top: 0;">
                            <button class="za-btn za-btn-warning" onclick="exportAndUploadBackup()">
                                <span>ZIP</span> å¯¼å‡ºå®Œæ•´å¤‡ä»½
                            </button>
                            <button class="za-btn za-btn-error" onclick="clearData()">
                                <span>âš ï¸</span> æ¸…ç©ºæ‰€æœ‰æ•°æ®
                            </button>
                        </div>
                        <p class="hint-text hint-error" style="margin-top: 1rem; margin-bottom: 0;">å®Œæ•´å¤‡ä»½åŒ…å«æ•°æ®è¡¨å’Œæ‰€æœ‰å›¾ç‰‡ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºã€‚</p>
                    </div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="upload-card">
                    <h3 class="module-title">ğŸ“‹ å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨</h3>
                    <div id="filesList" class="files-list-container">
                        <!-- æ–‡ä»¶åˆ—è¡¨å†…å®¹ç”± JS æ¸²æŸ“ -->
                    </div>
                </div>
                
            </div>
            
        </div>
        
    </div>
    
    <!-- PhotoSwipe JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/umd/photoswipe.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/umd/photoswipe-lightbox.umd.min.js"></script>
    
    <script>
        // ============== å…¨å±€å˜é‡å’Œåˆå§‹åŒ– ==============
        var catalogData = {};
        var uploadedFiles = [];
        var searchResults = [];
        var fuzzyMatches = [];
        var rangeResults = [];
        var searchTimeout;
        var searchHistory = [];
        var editingCode = null;
        var manageSearchTerm = '';
        
        // Cloudflare R2é…ç½®
        var r2Config = JSON.parse(localStorage.getItem('r2-config') || '{}');
        var s3Client = null;
        
        // äº§å“ç®¡ç†åˆ†é¡µå˜é‡
        var manageCurrentPage = 1;
        var managePageSize = 20;
        var filteredManageProducts = [];
        var hasMoreProducts = false;

        // PhotoSwipeå®ä¾‹
        var photoSwipeLightbox = null;

        // ============== PhotoSwipeå›¾ç‰‡æŸ¥çœ‹å™¨åˆå§‹åŒ– ==============
        function initPhotoSwipe() {
            if (photoSwipeLightbox) {
                photoSwipeLightbox.destroy();
            }
            
            photoSwipeLightbox = new PhotoSwipeLightbox({
                gallery: '#resultsArea, #manageProductList',
                children: 'a.view-image-link, a.manage-product-image-link',
                pswpModule: PhotoSwipe,
                wheelToZoom: true,
                initialZoomLevel: 'fit',
                secondaryZoomLevel: 2,
                maxZoomLevel: 4,
                closeOnVerticalDrag: true,
                hideAnimationDuration: 200,
                showAnimationDuration: 200,
                zoomAnimationDuration: 200,
                bgOpacity: 0.9
            });
            
            // æ·»åŠ è‡ªå®šä¹‰ä¸‹è½½æŒ‰é’®
            photoSwipeLightbox.on('uiRegister', function() {
                photoSwipeLightbox.pswp.ui.registerElement({
                    name: 'download-button',
                    order: 8,
                    isButton: true,
                    tagName: 'a',
                    html: 'â¬‡ï¸',
                    onInit: (el, pswp) => {
                        el.setAttribute('download', '');
                        el.setAttribute('target', '_blank');
                        el.setAttribute('rel', 'noopener');
                        el.setAttribute('title', 'ä¸‹è½½å›¾ç‰‡');
                        
                        pswp.on('change', () => {
                            const slide = pswp.currSlide;
                            if (slide) {
                                el.href = slide.data.src;
                            }
                        });
                    }
                });
            });
            
            photoSwipeLightbox.init();
            console.log('PhotoSwipeå›¾ç‰‡æŸ¥çœ‹å™¨å·²åˆå§‹åŒ–');
        }

        // ============== å›¾ç‰‡ç›¸å…³å‡½æ•° ==============
        function handleImageError(imgElement, productCode) {
            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', imgElement.src);
            imgElement.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYc8L3RleHQ+PC9zdmc+';
        }

        // ============== æ¸²æŸ“å‡½æ•° ==============
        function renderProductCard(product) {
            var html = '<div class="product-card" data-code="' + product.code + '">'; 
            html += '<div class="product-content">';
            html += '<div class="product-header">';
            html += '<div class="code-block">';
            html += '<span class="code-label">Product Code</span>';
            html += '<span class="product-code">' + product.code + '</span>';
            html += '</div>';
            html += '<span class="match-badge">' + (product.matchType === 'exact' ? 'ç²¾ç¡®åŒ¹é…' : product.matchType === 'fuzzy' ? 'æ¨¡ç³ŠåŒ¹é…' : 'åŒºé—´åŒ¹é…') + '</span>';
            html += '</div>';
            
            // è§„æ ¼ç½‘æ ¼
            html += '<div class="specs-grid">';
            html += '<div class="spec-item"><label>ğŸ’° ç ä»· (Y)</label><div class="value price-highlight">' + product.price + '</div></div>';
            html += '<div class="spec-item"><label>ğŸ’° ç±³ä»· (M)</label><div class="value price-highlight">' + product.priceAlt + '</div></div>';
            html += '<div class="spec-item"><label>ğŸ“ é—¨å¹…</label><div class="value">' + product.width + '</div></div>';
            html += '<div class="spec-item"><label>âš–ï¸ å…‹é‡</label><div class="value">' + product.weight + '</div></div>';
            html += '<div class="spec-item" style="grid-column: span 2;"><label>ğŸ§µ æˆåˆ†</label><div class="value">' + product.composition + '</div></div>';
            html += '</div>';

            if (product.notes && product.notes !== '-') {
                html += '<div class="manage-product-notes">' + product.notes + '</div>';
            }
            
            // ä¾›åº”å•†å¸ƒå±€
            html += '<div class="supplier-box">';
            html += '<div class="supplier-label">';
            html += '<div class="supplier-icon">' + (product.supplier ? product.supplier.charAt(0) : '?') + '</div>';
            html += product.supplier;
            html += '</div>';
            if (product.image) {
                html += '<a href="' + product.image + '" class="view-image-link" data-pswp-width="1200" data-pswp-height="1600">æŸ¥çœ‹åº•å¡ â†’</a>';
            } else {
                html += '<span style="color: var(--text-secondary); font-size: 0.8rem;">æ— åº•å¡å›¾ç‰‡</span>';
            }
            html += '</div>';
            
            html += '</div></div>';
            return html;
        }

        function renderResults() {
            var html = '';
            if (rangeResults.length > 0) {
                rangeResults.forEach(function(range) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h3 class="module-title">ğŸ“Š ' + range.label + ' - ' + range.matches.length + ' ä¸ªåŒ¹é…äº§å“</h3>';
                    range.matches.forEach(function(product) {
                        html += renderProductCard(product);
                    });
                    html += '</div>';
                });
            } else {
                if (fuzzyMatches.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h3 class="module-title">ğŸ¯ æ¨¡ç³ŠåŒ¹é…ç»“æœ</h3>';
                    fuzzyMatches.forEach(function(group) {
                        html += '<div style="margin-bottom: 1rem;">';
                        html += '<p style="font-weight: 600; color: var(--text-secondary);">æœç´¢è¯ "' + group.searchTerm + '" æ‰¾åˆ° ' + group.matches.length + ' ä¸ªåŒ¹é…ï¼š</p>';
                        html += '<div class="search-history">';
                        group.matches.forEach(function(code) {
                            html += '<div class="history-item" onclick="selectFuzzyMatch(\'' + code + '\')">' + code + '</div>';
                        });
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }
                searchResults.forEach(function(result) {
                    if (result.found) {
                        html += renderProductCard(result);
                    } else {
                        html += '<div class="product-card" style="background: #fde8e8; border-color: #EF9A9A;">';
                        html += '<div class="product-content">';
                        html += '<div class="product-header">';
                        html += '<div class="code-block">';
                        html += '<span class="code-label">Product Code</span>';
                        html += '<span class="product-code">' + result.code + '</span>';
                        html += '</div>';
                        html += '<span class="match-badge" style="background: #EF9A9A; color: white;">æœªæ‰¾åˆ°</span>';
                        html += '</div>';
                        html += '<div style="text-align: center; padding: 1.5rem; color: #EF9A9A; font-weight: 600;">' + result.error + '</div>';
                        html += '</div></div>';
                    }
                });
            }
            document.getElementById('resultsArea').innerHTML = html;
            updateStats();
            initPhotoSwipe();
        }

        function renderManageProductCard(product) {
            var html = '<div class="manage-product-card" data-code="' + product.code + '">';
            html += '<div class="manage-product-content">';
            html += '<div class="manage-product-header">';
            html += '<div class="code-block">';
            html += '<span class="code-label">Product Code</span>';
            html += '<span class="manage-product-code">' + product.code + '</span>';
            html += '</div>';
            html += '</div>';
            html += '<div class="manage-specs-grid">';
            html += '<div class="manage-spec-item"><label>ğŸ’° ç ä»·</label><div class="value price-highlight">' + product.price + '</div></div>';
            html += '<div class="manage-spec-item"><label>ğŸ’° ç±³ä»·</label><div class="value price-highlight">' + product.priceAlt + '</div></div>';
            html += '<div class="manage-spec-item"><label>ğŸ“ é—¨å¹…</label><div class="value">' + product.width + '</div></div>';
            html += '<div class="manage-spec-item"><label>âš–ï¸ å…‹é‡</label><div class="value">' + product.weight + '</div></div>';
            html += '<div class="manage-product-full-row"><label>ğŸ§µ æˆåˆ†</label><div class="value">' + product.composition + '</div></div>';
            html += '<div class="manage-product-full-row"><label>ğŸ­ ä¾›åº”å•†</label><div class="value">' + product.supplier + '</div></div>';
            if (product.notes && product.notes !== '-') {
                html += '<div class="manage-product-notes">' + product.notes + '</div>';
            }
            html += '</div>';
            html += '</div>';
            html += '<div class="manage-product-footer">';
            html += '<div class="manage-product-image-container">';
            if (product.image) {
                html += '<a href="' + product.image + '" class="manage-product-image-link" data-pswp-width="1200" data-pswp-height="1600">';
                html += '<img class="manage-product-image" src="' + product.image + '" alt="äº§å“å›¾ç‰‡" onerror="handleImageError(this, \'' + product.code + '\')">';
                html += '</a>';
            } else {
                html += '<span style="color: var(--text-secondary); text-align: center; padding: 0.5rem;">æ— å›¾ç‰‡</span>';
            }
            html += '</div>';
            html += '<div class="manage-product-actions">';
            html += '<button class="btn-edit" onclick="editProduct(\'' + product.code + '\')">ç¼–è¾‘</button>';
            html += '<button class="btn-remove" onclick="deleteProductFromList(\'' + product.code + '\')">åˆ é™¤</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            return html;
        }

        function renderManageProducts() {
            var listDiv = document.getElementById('manageProductList');
            var html = '';
            var products = Object.values(catalogData).filter(function(p) {
                return p.code.toUpperCase().includes(manageSearchTerm) || (p.supplier && p.supplier.toUpperCase().includes(manageSearchTerm));
            });
            filteredManageProducts = products.sort(function(a, b) {
                var seriesA = a.code.match(/^[YC]*([ACDFGJMST])/);
                var seriesB = b.code.match(/^[YC]*([ACDFGJMST])/);
                seriesA = seriesA ? seriesA[1] : '';
                seriesB = seriesB ? seriesB[1] : '';
                if (seriesA !== seriesB) return seriesA.localeCompare(seriesB);
                var numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                var numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                return numA - numB;
            });
            var start = (manageCurrentPage - 1) * managePageSize;
            var end = start + managePageSize;
            var pageProducts = filteredManageProducts.slice(start, end);
            pageProducts.forEach(function(product) {
                html += renderManageProductCard(product);
            });
            listDiv.innerHTML = html;
            hasMoreProducts = end < filteredManageProducts.length;
            document.getElementById('loadMoreContainer').style.display = hasMoreProducts ? 'block' : 'none';
            initPhotoSwipe();
        }

        // ============== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==============
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œå†…å®¹çš„ active çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // æ¿€æ´»å½“å‰æ ‡ç­¾é¡µ
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Btn').classList.add('active');

            // å»¶è¿ŸåŠ è½½éæ´»åŠ¨æ ‡ç­¾é¡µå†…å®¹
            if (tabName === 'manage') {
                setTimeout(() => {
                    renderManageProducts();
                }, 50);
            } else if (tabName === 'data') {
                setTimeout(() => {
                    renderFilesList();
                    loadR2Config();
                }, 50);
            }
            
            // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
            if (tabName === 'manage') {
                setTimeout(checkStorageStatus, 100);
            }
        }

        function updateStats() {
            document.getElementById('dataCount').textContent = Object.keys(catalogData).length;
            
            // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ ç»Ÿè®¡
            updateStorageStats();
            
            // æŠ¥ä»·PDFæŒ‰é’®æ§åˆ¶
            var hasResults = searchResults.length > 0 || rangeResults.length > 0;
            document.getElementById('quotePDFBtn').style.display = hasResults ? 'inline-block' : 'none';
        }
        
        function updateStorageStats() {
            const totalProducts = Object.keys(catalogData).length;
            let r2Images = 0;
            let localImages = 0;
            let missingImages = 0;
            
            Object.values(catalogData).forEach(product => {
                if (product.image) {
                    if (product.image.includes(r2Config.customDomain) || product.image.includes('.r2.cloudflarestorage.com')) {
                        r2Images++;
                    } else if (product.image.startsWith('data:image')) {
                        localImages++;
                    } else {
                        // å…¶ä»–ç±»å‹çš„å›¾ç‰‡é“¾æ¥è§†ä¸ºR2å›¾ç‰‡ï¼ˆå‡è®¾ä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼‰
                        r2Images++;
                    }
                } else {
                    missingImages++;
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('r2ImageCount').textContent = r2Images;
            document.getElementById('localImageCount').textContent = localImages;
            document.getElementById('missingImageCount').textContent = missingImages;
            
            // æ›´æ–°å­˜å‚¨ç”¨é‡ï¼ˆä¼°ç®—ï¼‰
            const estimatedSize = estimateDataSize();
            document.getElementById('storageUsage').textContent = formatBytes(estimatedSize, 1);
            
            // æ›´æ–°ç³»ç»Ÿå¥åº·çŠ¶æ€
            const healthScore = calculateHealthScore(totalProducts, r2Images, missingImages);
            document.getElementById('systemHealth').textContent = healthScore;
            
            // æ›´æ–°å­˜å‚¨åˆ†å¸ƒ
            document.getElementById('localStorageBadge').textContent = `æœ¬åœ°: ${localImages}`;
            document.getElementById('r2StorageBadge').textContent = `R2: ${r2Images}`;
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€
            document.getElementById('storageSyncStatus').textContent = s3Client ? 'âœ… äº‘ç«¯åŒæ­¥' : 'âš ï¸ ä»…æœ¬åœ°';
        }
        
        function estimateDataSize() {
            let size = 0;
            
            // ä¼°ç®—catalogDataå¤§å°
            const dataStr = JSON.stringify(catalogData);
            size += new Blob([dataStr]).size;
            
            // ä¼°ç®—å›¾ç‰‡å¤§å° (base64å›¾ç‰‡)
            Object.values(catalogData).forEach(product => {
                if (product.image && product.image.startsWith('data:image')) {
                    // base64å›¾ç‰‡å¤§å°çº¦ä¸ºåŸå§‹æ•°æ®çš„4/3
                    size += product.image.length * 3 / 4;
                }
            });
            
            return size;
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function calculateHealthScore(totalProducts, r2Images, missingImages) {
            if (totalProducts === 0) return '0%';
            
            let score = 100;
            
            // ç¼ºå¤±å›¾ç‰‡æ‰£åˆ†
            score -= (missingImages / totalProducts) * 50;
            
            // R2å›¾ç‰‡æ¯”ä¾‹åŠ åˆ†
            const r2Ratio = r2Images / (totalProducts - missingImages);
            score += r2Ratio * 20;
            
            // ç¡®ä¿åˆ†æ•°åœ¨0-100ä¹‹é—´
            score = Math.max(0, Math.min(100, score));
            
            return Math.round(score) + '%';
        }

        function showStatus(message, type, targetId = 'dataStatusMsg') {
            var statusDiv = document.getElementById(targetId);
            if (!statusDiv) return;

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-msg status-' + type;
            statusDiv.innerHTML = message;

            if (type === 'success' || type === 'error') {
                setTimeout(function() { statusDiv.style.display = 'none'; }, 5000);
            }
        }
        
        function checkStorageStatus() {
            const storageStatus = document.getElementById('storageStatus');
            const storageStatusText = document.getElementById('storageStatusText');
            
            // è®¡ç®—å½“å‰æ•°æ®å¤§å°
            const dataSize = estimateDataSize();
            
            // è®¾ç½®é˜ˆå€¼
            const warningThreshold = 10 * 1024 * 1024; // 10MB
            const criticalThreshold = 30 * 1024 * 1024; // 30MB
            
            if (dataSize > criticalThreshold) {
                storageStatus.className = 'hint-text hint-error';
                storageStatusText.innerHTML = `âš ï¸ å­˜å‚¨ç©ºé—´ç´§å¼  (${formatBytes(dataSize)}) - å»ºè®®ç«‹å³è¿ç§»åˆ°Cloudflare R2`;
                storageStatus.style.display = 'block';
            } else if (dataSize > warningThreshold) {
                storageStatus.className = 'hint-text';
                storageStatusText.innerHTML = `ğŸ’¾ å­˜å‚¨ä½¿ç”¨é‡è¾ƒé«˜ (${formatBytes(dataSize)}) - å»ºè®®é…ç½®Cloudflare R2`;
                storageStatus.style.display = 'block';
            } else {
                storageStatus.style.display = 'none';
            }
        }

        // ============== æœç´¢åŠŸèƒ½ ==============
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            var value = e.target.value.trim();
            if (value && Object.keys(catalogData).length > 0) {
                searchTimeout = setTimeout(function() {
                    handleSearch(value);
                    renderResults();
                }, 300);
            } else {
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                renderResults();
            }
        });
        
        function renderHistory() {
            var historyDiv = document.getElementById('searchHistory');
            var html = '';
            searchHistory.slice(-5).reverse().forEach(function(h) {
                html += '<div class="history-item" onclick="loadHistory(\'' + h.replace(/'/g, "\\'") + '\')">' + h + '</div>';
            });
            historyDiv.innerHTML = html;
        }

        function loadHistory(query) {
            document.getElementById('searchInput').value = query;
            handleSearch(query);
            renderResults();
            switchTab('query');
        }

        function clearSearchHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ')) {
                searchHistory = [];
                saveDataToR2();
                renderHistory();
                showStatus('æœç´¢å†å²å·²æ¸…é™¤', 'success', 'dataStatusMsg');
            }
        }

        function parseRangeInput(input) {
            var ranges = [];
            var items = input.split(/[,ï¼Œ\s]+/).map(function(item) { return item.trim(); }).filter(function(item) { return item; });
            var type = null;
            items.forEach(function(item) {
                var upper = item.toUpperCase();
                var min = null, max = null, label = item;
                if (upper.includes('å…ƒ')) {
                    type = 'price';
                    if (upper.includes('ä»¥ä¸Š')) {
                        min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        max = Infinity;
                    } else if (upper.includes('å†…')) {
                        max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        min = 0;
                    } else {
                        var match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…ƒ/);
                        if (match) {
                            min = parseFloat(match[1]);
                            max = parseFloat(match[2]);
                        }
                    }
                } else if (upper.includes('å…‹')) {
                    type = 'weight';
                    if (upper.includes('ä»¥ä¸Š')) {
                        min = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        max = Infinity;
                    } else if (upper.includes('å†…')) {
                        max = parseFloat(upper.replace(/[^0-9.]/g, ''));
                        min = 0;
                    } else {
                        var match = upper.match(/(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)å…‹/);
                        if (match) {
                            min = parseFloat(match[1]);
                            max = parseFloat(match[2]);
                        }
                    }
                }
                if (min !== null || max !== null) {
                    ranges.push({ min: min, max: max, label: label, type: type });
                }
            });
            return { ranges: ranges, type: type };
        }

        function performRangeQuery(ranges, type) {
            var results = [];
            var field = type === 'price' ? 'priceAlt' : 'weight';
            ranges.forEach(function(range) {
                var matches = [];
                Object.values(catalogData).forEach(function(product) {
                    var value = parseFloat(product[field]);
                    if (!isNaN(value) && value >= (range.min || 0) && value <= (range.max || Infinity)) {
                        var match = JSON.parse(JSON.stringify(product));
                        match.matchType = 'range';
                        match.rangeLabel = range.label;
                        matches.push(match);
                    }
                });
                matches.sort(function(a, b) {
                    var seriesA = a.code.match(/^[YC]*([ACDFGJMST])/);
                    var seriesB = b.code.match(/^[YC]*([ACDFGJMST])/);
                    seriesA = seriesA ? seriesA[1] : '';
                    seriesB = seriesB ? seriesB[1] : '';
                    if (seriesA !== seriesB) return seriesA.localeCompare(seriesB);
                    var numA = parseInt(a.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                    var numB = parseInt(b.code.replace(/^[YC]*[ACDFGJMST]/, '')) || 0;
                    return numA - numB;
                });
                var result = JSON.parse(JSON.stringify(range));
                result.matches = matches;
                results.push(result);
            });
            return results;
        }

        function handleSearch(inputValue) {
            var input = (inputValue || document.getElementById('searchInput').value).trim().toUpperCase();
            if (!input) {
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                return;
            }
            if (!searchHistory.includes(input)) {
                searchHistory.push(input);
                if (searchHistory.length > 10) searchHistory.shift();
                saveDataToR2();
                renderHistory();
            }
            var parsed = parseRangeInput(input);
            if (parsed.ranges.length > 0 && (parsed.type === 'price' || parsed.type === 'weight')) {
                rangeResults = performRangeQuery(parsed.ranges, parsed.type);
                searchResults = [];
                fuzzyMatches = [];
            } else {
                var codes = input.split(/[\s,;\n]+/).map(function(c) { return c.trim(); }).filter(function(c) { return c.length > 0; });
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
                codes.forEach(function(code) {
                    if (catalogData[code]) {
                        var result = JSON.parse(JSON.stringify(catalogData[code]));
                        result.found = true;
                        result.matchType = 'exact';
                        searchResults.push(result);
                    } else {
                        var matches = Object.keys(catalogData).filter(function(key) {
                            var product = catalogData[key];
                            var codeMatch = key.toUpperCase().includes(code);
                            var supplierMatch = product.supplier && product.supplier !== '-' &&
                                              product.supplier.toUpperCase().includes(code);
                            return codeMatch || supplierMatch;
                        });
                        if (matches.length === 1) {
                            var result = JSON.parse(JSON.stringify(catalogData[matches[0]]));
                            result.found = true;
                            result.matchType = 'fuzzy';
                            searchResults.push(result);
                        } else if (matches.length > 1) {
                            fuzzyMatches.push({ searchTerm: code, matches: matches.slice(0, 50) });
                        } else {
                            searchResults.push({ code: code, found: false, error: 'æœªæ‰¾åˆ°è¯¥äº§å“' });
                        }
                    }
                });
            }
        }

        function selectFuzzyMatch(code) {
            document.getElementById('searchInput').value = code;
            handleSearch(code);
            renderResults();
            switchTab('query');
        }

        // ============== äº§å“ç®¡ç†åŠŸèƒ½ ==============
        async function addOrUpdateProduct() {
            var code = document.getElementById('codeInput').value.trim().toUpperCase();
            if (!code || !code.match(/^[YC]*[ACDFGJMST]\d+/)) {
                showStatus('äº§å“ä»£ç æ ¼å¼æ— æ•ˆï¼ˆä¾‹å¦‚ï¼šC6001, YC2001ï¼‰', 'error', 'manageFormStatus');
                return;
            }
            if (catalogData[code] && editingCode !== code) {
                if (!confirm('äº§å“ä»£ç å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) return;
            }
            
            var imageFile = document.getElementById('imageInput').files[0];
            var imageUrl = catalogData[code] ? catalogData[code].image : null;
            
            if (imageFile) {
                if (imageFile.size > 5 * 1024 * 1024) {
                    showStatus('å›¾ç‰‡è¿‡å¤§ï¼ˆ>5MBï¼‰ï¼Œè¯·å‹ç¼©åä¸Šä¼ ', 'error', 'manageFormStatus');
                    return;
                }
                
                try {
                    // ä¸Šä¼ åˆ°Cloudflare R2ï¼Œä½¿ç”¨ç»Ÿä¸€çš„äº§å“ä»£ç å‘½å
                    imageUrl = await uploadToR2(imageFile, code);
                    showStatus('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success', 'manageFormStatus');
                } catch (error) {
                    console.error('Cloudflare R2ä¸Šä¼ å¤±è´¥:', error);
                    showStatus('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error', 'manageFormStatus');
                    return;
                }
            }
            
            saveProductData(code, imageUrl);
        }

        function editProduct(code) {
            var product = catalogData[code];
            if (!product) return;
            
            switchTab('manage');
            
            setTimeout(() => {
                const formElement = document.getElementById('manageForm').closest('.upload-card');
                if (formElement) {
                    formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100); 

            editingCode = code;
            document.getElementById('codeInput').value = product.code;
            document.getElementById('priceInput').value = product.price;
            document.getElementById('priceAltInput').value = product.priceAlt;
            document.getElementById('widthInput').value = product.width;
            document.getElementById('compositionInput').value = product.composition;
            document.getElementById('weightInput').value = product.weight;
            document.getElementById('notesInput').value = product.notes;
            document.getElementById('supplierInput').value = product.supplier;

            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'inline-block';
            document.getElementById('deleteBtn').style.display = 'inline-block';
            showStatus('ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹åç‚¹å‡»"æ›´æ–°äº§å“"', 'loading', 'manageFormStatus');
        }

        function deleteProduct() {
            if (!editingCode || !confirm('ç¡®å®šåˆ é™¤æ­¤äº§å“ ' + editingCode + ' å—ï¼Ÿ')) return;
            delete catalogData[editingCode];
            saveDataToR2().then(() => {
                updateStats();
                renderManageProducts();
                clearForm();
                showStatus('äº§å“å·²åˆ é™¤', 'success', 'manageFormStatus');
                checkStorageStatus();
            });
        }

        function clearForm() {
            document.getElementById('manageForm').reset();
            document.getElementById('imageInput').value = '';
            document.getElementById('bulkImageInput').value = '';
            editingCode = null;
            document.getElementById('addBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            showStatus('è¡¨å•å·²æ¸…ç©º', 'loading', 'manageFormStatus');
            document.getElementById('manageFormStatus').style.display = 'none';
        }

        function filterManageProducts() {
            manageSearchTerm = document.getElementById('manageSearchInput').value.toUpperCase();
            manageCurrentPage = 1;
            renderManageProducts();
        }

        function loadMoreProducts() {
            manageCurrentPage++;
            renderManageProducts();
        }

        function deleteProductFromList(code) {
            if (confirm('ç¡®å®šåˆ é™¤äº§å“ ' + code + 'ï¼Ÿ')) {
                delete catalogData[code];
                saveDataToR2().then(() => {
                    updateStats();
                    renderManageProducts();
                    showStatus('äº§å“å·²åˆ é™¤', 'success', 'manageFormStatus');
                    checkStorageStatus();
                });
            }
        }

        function saveProductData(code, imageUrl) {
            // å¦‚æœimageUrlä¸ºç©ºï¼Œä½†äº§å“å·²æœ‰å›¾ç‰‡ï¼Œä¿ç•™åŸæœ‰å›¾ç‰‡
            const existingImage = catalogData[code] ? catalogData[code].image : null;
            
            catalogData[code] = {
                code: code,
                price: document.getElementById('priceInput').value || '-',
                priceAlt: document.getElementById('priceAltInput').value || '-',
                width: document.getElementById('widthInput').value || '-',
                composition: document.getElementById('compositionInput').value || '-',
                weight: document.getElementById('weightInput').value || '-',
                notes: document.getElementById('notesInput').value || '-',
                supplier: document.getElementById('supplierInput').value || '-',
                image: imageUrl || existingImage // ç¡®ä¿å›¾ç‰‡ä¸è¢«æ„å¤–æ¸…é™¤
            };
            
            console.log('ä¿å­˜äº§å“æ•°æ®:', code, 'å›¾ç‰‡URL:', catalogData[code].image);
            
            saveDataToR2().then(() => {
                updateStats();
                renderManageProducts();
                if (editingCode) {
                    showStatus('äº§å“å·²æ›´æ–°', 'success', 'manageFormStatus');
                    clearForm();
                } else {
                    showStatus('äº§å“å·²æ·»åŠ ', 'success', 'manageFormStatus');
                    clearForm();
                }
                checkStorageStatus();
                
                // é‡æ–°ç»‘å®šå›¾ç‰‡äº‹ä»¶
                setTimeout(initPhotoSwipe, 100);
            }).catch(error => {
                console.error('Save error:', error);
                showStatus('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error', 'manageFormStatus');
            });
        }

        // ============== R2é…ç½®å’Œå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==============
        function saveR2Config() {
            r2Config = {
                accountId: document.getElementById('r2AccountId').value.trim(),
                accessKey: document.getElementById('r2AccessKey').value.trim(),
                secretKey: document.getElementById('r2SecretKey').value.trim(),
                bucket: document.getElementById('r2Bucket').value.trim(),
                customDomain: document.getElementById('r2CustomDomain').value.trim()
            };
            localStorage.setItem('r2-config', JSON.stringify(r2Config));
            loadR2Config();
            showStatus('é…ç½®å·²ä¿å­˜', 'success', 'dataStatusMsg');
        }

        function loadR2Config() {
            r2Config = JSON.parse(localStorage.getItem('r2-config') || '{}');
            document.getElementById('r2AccountId').value = r2Config.accountId || '';
            document.getElementById('r2AccessKey').value = r2Config.accessKey || '';
            document.getElementById('r2SecretKey').value = r2Config.secretKey || '';
            document.getElementById('r2Bucket').value = r2Config.bucket || '';
            document.getElementById('r2CustomDomain').value = r2Config.customDomain || 'https://img.yudong-textile.top';
            if (r2Config.accessKey && r2Config.secretKey && r2Config.accountId && r2Config.bucket) {
                s3Client = new AWS.S3({
                    endpoint: `https://${r2Config.accountId}.r2.cloudflarestorage.com`,
                    accessKeyId: r2Config.accessKey,
                    secretAccessKey: r2Config.secretKey,
                    s3ForcePathStyle: true,
                    signatureVersion: 'v4',
                    region: 'auto'
                });
            } else {
                s3Client = null;
            }
        }

        function testR2Connection() {
            loadR2Config();
            if (!r2Config.accessKey || !r2Config.secretKey || !r2Config.bucket || !r2Config.accountId) {
                showStatus('è¯·å…ˆå®Œæ•´å¡«å†™R2é…ç½®', 'error', 'dataStatusMsg');
                return;
            }
            
            s3Client = new AWS.S3({
                endpoint: `https://${r2Config.accountId}.r2.cloudflarestorage.com`,
                accessKeyId: r2Config.accessKey,
                secretAccessKey: r2Config.secretKey,
                s3ForcePathStyle: true,
                signatureVersion: 'v4',
                region: 'auto'
            });
            
            showStatus('æ­£åœ¨æµ‹è¯•R2è¿æ¥...', 'loading', 'dataStatusMsg');
            
            const testKey = `yudong-test/test-${Date.now()}.txt`;
            const testContent = 'Cloudflare R2 connection test';
            
            s3Client.putObject({
                Bucket: r2Config.bucket,
                Key: testKey,
                Body: testContent,
                ContentType: 'text/plain'
            }, function(err) {
                if (err) {
                    let errorMsg = 'R2è¿æ¥æµ‹è¯•å¤±è´¥: ';
                    if (err.code === 'AccessDenied') {
                        errorMsg += 'è®¿é—®æ‹’ç» - è¯·æ£€æŸ¥Access Keyæƒé™';
                    } else if (err.code === 'InvalidAccessKeyId') {
                        errorMsg += 'æ— æ•ˆçš„Access Key ID';
                    } else if (err.code === 'SignatureDoesNotMatch') {
                        errorMsg += 'ç­¾åä¸åŒ¹é… - è¯·æ£€æŸ¥Secret Key';
                    } else if (err.code === 'NoSuchBucket') {
                        errorMsg += 'å­˜å‚¨æ¡¶ä¸å­˜åœ¨ - è¯·æ£€æŸ¥Bucketåç§°';
                    } else if (err.code === 'NetworkingError' || err.message?.includes('CORS')) {
                        errorMsg = 'ç½‘ç»œé”™è¯¯ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CORSé…ç½®';
                    } else {
                        errorMsg += err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®';
                    }
                    
                    showStatus(errorMsg, 'error', 'dataStatusMsg');
                } else {
                    // æµ‹è¯•æˆåŠŸï¼Œåˆ é™¤æµ‹è¯•æ–‡ä»¶
                    s3Client.deleteObject({
                        Bucket: r2Config.bucket,
                        Key: testKey
                    }, function(deleteErr) {
                        if (deleteErr) {
                            console.warn('æµ‹è¯•æ–‡ä»¶åˆ é™¤å¤±è´¥:', deleteErr);
                        }
                    });
                    
                    // æµ‹è¯•è‡ªå®šä¹‰åŸŸåè®¿é—®
                    testCustomDomainAccess();
                }
            });
        }
        
        function testCustomDomainAccess() {
            if (!r2Config.customDomain) {
                showStatus('âœ… R2è¿æ¥æµ‹è¯•æˆåŠŸï¼é…ç½®æ­£ç¡®ã€‚', 'success', 'dataStatusMsg');
                return;
            }
            
            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾ç‰‡URL
            const testImageUrl = `${r2Config.customDomain}/yudong-fabric/test-image-${Date.now()}.jpg`;
            
            // æµ‹è¯•å›¾ç‰‡åŠ è½½
            const testImage = new Image();
            testImage.onload = function() {
                showStatus('âœ… R2è¿æ¥æµ‹è¯•æˆåŠŸï¼è‡ªå®šä¹‰åŸŸåè®¿é—®æ­£å¸¸ã€‚', 'success', 'dataStatusMsg');
            };
            testImage.onerror = function() {
                showStatus('âš ï¸ R2è¿æ¥æˆåŠŸï¼Œä½†è‡ªå®šä¹‰åŸŸåè®¿é—®å¯èƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥åŸŸåè§£æã€‚', 'warning', 'dataStatusMsg');
            };
            testImage.src = testImageUrl;
        }

        function generateImageUrl(productCode) {
            if (!r2Config.customDomain) {
                console.warn('R2è‡ªå®šä¹‰åŸŸåæœªé…ç½®');
                return null;
            }
            
            // ç¡®ä¿customDomainä»¥æ–œæ ç»“å°¾ï¼Œè·¯å¾„æ ¼å¼æ­£ç¡®
            const baseUrl = r2Config.customDomain.endsWith('/') 
                ? r2Config.customDomain 
                : r2Config.customDomain + '/';
            
            // ç”Ÿæˆæ ‡å‡†çš„å›¾ç‰‡URL
            return `${baseUrl}yudong-fabric/${productCode}.jpg`;
        }

        async function uploadToR2(file, productCode) {
            return new Promise((resolve, reject) => {
                if (!s3Client) {
                    reject(new Error('è¯·å…ˆé…ç½®Cloudflare R2'));
                    return;
                }
                
                // ä½¿ç”¨ç»Ÿä¸€çš„äº§å“ä»£ç ä½œä¸ºæ–‡ä»¶åï¼ŒåŒ…å«è·¯å¾„å‰ç¼€
                const key = `yudong-fabric/${productCode}.jpg`;
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                document.getElementById('imageUploadProgress').style.display = 'block';
                document.getElementById('imageUploadProgressFill').style.width = '0%';
                
                // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ putObject è€Œä¸æ˜¯ uploadï¼Œå¹¶è®¾ç½®æ­£ç¡®çš„ ContentType
                s3Client.putObject({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: file,
                    ContentType: 'image/jpeg', // æ˜ç¡®æŒ‡å®š ContentType
                    // æ³¨æ„ï¼šR2 ä¸æ”¯æŒ ACL å‚æ•°ï¼Œéœ€è¦åœ¨ R2 æ§åˆ¶å°è®¾ç½®å…¬å…±è®¿é—®ç­–ç•¥
                }, function(err, data) {
                    document.getElementById('imageUploadProgress').style.display = 'none';
                    
                    if (err) {
                        console.error('R2ä¸Šä¼ å¤±è´¥:', err);
                        reject(err);
                    } else {
                        console.log('R2ä¸Šä¼ æˆåŠŸ:', data);
                        // ä½¿ç”¨ä¿®å¤åçš„URLç”Ÿæˆå‡½æ•°
                        const imageUrl = generateImageUrl(productCode);
                        console.log('ç”Ÿæˆçš„å›¾ç‰‡URL:', imageUrl);
                        
                        // éªŒè¯å›¾ç‰‡URLæ˜¯å¦å¯è®¿é—®
                        verifyImageAccess(imageUrl, productCode)
                            .then(() => resolve(imageUrl))
                            .catch(verifyErr => {
                                console.warn('å›¾ç‰‡éªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­ä½¿ç”¨URL:', verifyErr);
                                resolve(imageUrl); // å³ä½¿éªŒè¯å¤±è´¥ä¹Ÿè¿”å›URL
                            });
                    }
                });
            });
        }

        function verifyImageAccess(imageUrl, productCode) {
            return new Promise((resolve, reject) => {
                const testImage = new Image();
                testImage.onload = function() {
                    console.log(`âœ… å›¾ç‰‡ ${productCode} å¯æ­£å¸¸è®¿é—®`);
                    resolve();
                };
                testImage.onerror = function() {
                    console.error(`âŒ å›¾ç‰‡ ${productCode} æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥R2å…¬å…±è®¿é—®è®¾ç½®`);
                    reject(new Error(`å›¾ç‰‡ ${productCode} æ— æ³•å…¬å¼€è®¿é—®`));
                };
                testImage.src = imageUrl + '?t=' + Date.now(); // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
            });
        }

        // ============== æ•°æ®å¤‡ä»½åŠŸèƒ½ ==============
        function exportAndUploadBackup() {
            if (Object.keys(catalogData).length === 0) {
                showStatus('æ— æ•°æ®å¯å¯¼å‡º', 'error', 'dataStatusMsg');
                return;
            }
           
            showStatus('æ­£åœ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶...', 'loading', 'dataStatusMsg');
           
            var zip = new JSZip();
            var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
           
            var fullData = {
                catalogData: catalogData,
                uploadedFiles: uploadedFiles,
                searchHistory: searchHistory,
                exportTime: new Date().toISOString(),
                version: '4.0-r2'
            };
           
            zip.file('database.json', JSON.stringify(fullData, null, 2));
           
            try {
                var rows = [['äº§å“ä»£ç ', 'ç ä»·', 'ç±³ä»·', 'é—¨å¹…', 'æˆåˆ†', 'å…‹é‡', 'å¤‡æ³¨', 'ä¾›åº”å•†']];
                Object.values(catalogData).forEach(function(p) {
                    rows.push([
                        p.code || '-',
                        p.price || '-',
                        p.priceAlt || '-',
                        p.width || '-',
                        p.composition || '-',
                        p.weight || '-',
                        p.notes || '-',
                        p.supplier || '-'
                    ]);
                });
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.aoa_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, 'äº§å“æ•°æ®');
                var xlsxBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                zip.file('äº§å“æ•°æ®è¡¨.xlsx', xlsxBuffer);
            } catch (xlsxError) {
                console.error('XLSX generation error:', xlsxError);
            }
           
            zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            }).then(async function(content) {
                // ä¸‹è½½åˆ°æœ¬åœ°
                var link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'å®‡ä¸œçººç»‡å…¨åº“å¤‡ä»½_' + timestamp + '.zip';
                link.click();
                URL.revokeObjectURL(link.href);
                
                // ä¸Šä¼ åˆ°Cloudflare R2
                try {
                    await uploadBackupToR2(content, link.download);
                    showStatus('âœ… å®Œæ•´å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼å·²åŒæ­¥åˆ°Cloudflare R2ã€‚', 'success', 'dataStatusMsg');
                } catch (error) {
                    console.error('å¤‡ä»½ä¸Šä¼ å¤±è´¥:', error);
                    showStatus('âœ… å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼Œä½†ä¸Šä¼ åˆ°R2å¤±è´¥: ' + error.message, 'warning', 'dataStatusMsg');
                }
            }).catch(function(error) {
                console.error('ZIP generation error:', error);
                showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error', 'dataStatusMsg');
            });
        }

        async function uploadBackupToR2(backupBlob, fileName) {
            return new Promise((resolve, reject) => {
                if (!s3Client) {
                    reject(new Error('è¯·å…ˆé…ç½®Cloudflare R2'));
                    return;
                }
                
                const key = `yudong-cloud/${fileName}`;
                
                s3Client.upload({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: backupBlob,
                    ContentType: 'application/zip'
                }, function(err, data) {
                    if (err) {
                        console.error('å¤‡ä»½ä¸Šä¼ å¤±è´¥:', err);
                        reject(err);
                    } else {
                        resolve(data);
                    }
                });
            });
        }

        function importDatabase(files) {
            if (files.length === 0) return;
            var file = files[0];
           
            showStatus('æ­£åœ¨å¯¼å…¥æ•°æ®åº“...', 'loading', 'dataStatusMsg');
           
            if (file.name.endsWith('.json')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = JSON.parse(e.target.result);
                        if (data.catalogData) {
                            catalogData = data.catalogData;
                            uploadedFiles = data.uploadedFiles || [];
                            searchHistory = data.searchHistory || [];
                        } else {
                            catalogData = data;
                        }
                        saveDataToR2().then(() => {
                            updateStats();
                            renderFilesList();
                            renderManageProducts();
                            renderResults();
                            renderHistory();
                            showStatus('âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼', 'success', 'dataStatusMsg');
                            checkStorageStatus();
                        });
                    } catch (err) {
                        console.error('JSON parse error:', err);
                        showStatus('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼é”™è¯¯ - ' + err.message, 'error', 'dataStatusMsg');
                    }
                };
                reader.onerror = function() { showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error', 'dataStatusMsg'); };
                reader.readAsText(file);
               
            } else if (file.name.endsWith('.zip')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    JSZip.loadAsync(e.target.result).then(function(zip) {
                        var jsonFile = zip.file('database.json') || zip.file('æ•°æ®åº“å¤‡ä»½.json');
                       
                        if (jsonFile) {
                            jsonFile.async('string').then(function(jsonStr) {
                                try {
                                    var data = JSON.parse(jsonStr);
                                    if (data.catalogData) {
                                        catalogData = data.catalogData;
                                        uploadedFiles = data.uploadedFiles || [];
                                        searchHistory = data.searchHistory || [];
                                    } else {
                                        catalogData = data;
                                    }
                                    saveDataToR2().then(() => {
                                        updateStats();
                                        renderFilesList();
                                        renderManageProducts();
                                        renderResults();
                                        renderHistory();
                                        showStatus('âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼å…± ' + Object.keys(catalogData).length + ' æ¡æ•°æ®', 'success', 'dataStatusMsg');
                                        checkStorageStatus();
                                    });
                                } catch (err) {
                                    console.error('JSON parse error:', err);
                                    showStatus('å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼é”™è¯¯', 'error', 'dataStatusMsg');
                                }
                            }).catch(function(err) {
                                console.error('JSON read error:', err);
                                showStatus('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è¯»å–JSONæ–‡ä»¶', 'error', 'dataStatusMsg');
                            });
                        } else {
                            showStatus('å¯¼å…¥å¤±è´¥ï¼šZIPä¸­æœªæ‰¾åˆ°database.jsonæˆ–æ•°æ®åº“å¤‡ä»½.json', 'error', 'dataStatusMsg');
                        }
                    }).catch(function(err) {
                        console.error('ZIP parse error:', err);
                        showStatus('å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„ZIPæ–‡ä»¶ - ' + err.message, 'error', 'dataStatusMsg');
                    });
                };
                reader.onerror = function() { showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error', 'dataStatusMsg'); };
                reader.readAsArrayBuffer(file);
            } else {
                showStatus('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼ .jsonæˆ–.zipæ–‡ä»¶', 'error', 'dataStatusMsg');
            }
        }

        document.getElementById('localDbInput').addEventListener('change', function(e) {
            importDatabase(e.target.files);
            e.target.value = '';
        });

        function clearData() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶å’Œäº§å“æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼')) {
                catalogData = {};
                uploadedFiles = [];
                searchResults = [];
                fuzzyMatches = [];
                rangeResults = [];
               
                saveDataToR2().then(() => {
                    updateStats();
                    renderFilesList();
                    renderResults();
                    renderManageProducts();
                    showStatus('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success', 'dataStatusMsg');
                    checkStorageStatus();
                });
            }
        }

        function renderFilesList() {
            var filesDiv = document.getElementById('filesList');
            if (uploadedFiles.length === 0) {
                filesDiv.innerHTML = '<div class="empty-state" style="text-align: center; padding: 1rem;"><div class="empty-icon" style="font-size:2rem; color: #ccc;">ğŸ“</div><div class="empty-subtext">æš‚æ— æ–‡ä»¶è®°å½•</div></div>';
                return;
            }
            var html = '';
            uploadedFiles.forEach(function(f) {
                html += '<div class="file-item"><div class="file-name">ğŸ“„ ' + f.name + '</div><div class="file-info">' + f.uploadTime + ' Â· ' + f.count + ' æ¡</div></div>';
            });
            filesDiv.innerHTML = html;
        }

        // ============== æ‰¹é‡å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==============
        document.getElementById('bulkImageInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // æ£€æŸ¥æ˜¯å¦é…ç½®äº†R2
            const hasR2Config = r2Config.accessKey && r2Config.secretKey && s3Client;
            
            if (!hasR2Config) {
                showStatus('è¯·å…ˆé…ç½®Cloudflare R2', 'error', 'manageFormStatus');
                return;
            }
            
            showStatus(`å¤„ç† ${files.length} å¼ å›¾ç‰‡...`, 'loading', 'manageFormStatus');
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            document.getElementById('bulkImageUploadProgress').style.display = 'block';
            document.getElementById('bulkImageUploadProgressFill').style.width = '0%';
            
            let success = 0, fail = 0;
            let failedFiles = [];
            let processed = 0;
            
            // ä¸²è¡Œå¤„ç†æ¯ä¸ªæ–‡ä»¶ï¼Œé¿å…å¹¶å‘é—®é¢˜
            for (const file of files) {
                const name = file.name.toUpperCase();
                
                // ä¿®å¤ï¼šæ›´çµæ´»çš„æ–‡ä»¶åè§£æï¼Œæ”¯æŒå„ç§å¸¸è§çš„å›¾ç‰‡æ‰©å±•å
                const code = name.replace(/\.(JPG|PNG|JPEG|GIF|BMP|WEBP|SVG)$/i, '').trim();
                
                if (!code) {
                    fail++;
                    failedFiles.push({ name: file.name, error: 'æ–‡ä»¶åæ— æ³•æå–äº§å“ä»£ç ' });
                    processed++;
                    updateBulkProgress(processed, files.length, success, fail);
                    continue;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    fail++;
                    failedFiles.push({ name: file.name, error: 'æ–‡ä»¶å¤§äº5MB' });
                    processed++;
                    updateBulkProgress(processed, files.length, success, fail);
                    continue;
                }
                
                if (!catalogData[code]) {
                    fail++;
                    failedFiles.push({ name: file.name, error: 'äº§å“ä»£ç ä¸å­˜åœ¨' });
                    processed++;
                    updateBulkProgress(processed, files.length, success, fail);
                    continue;
                }
                
                try {
                    // ä¸Šä¼ åˆ°R2
                    const imageUrl = await uploadToR2(file, code);
                    catalogData[code].image = imageUrl;
                    success++;
                } catch (error) {
                    fail++;
                    failedFiles.push({ name: file.name, error: error.message || 'ä¸Šä¼ å¤±è´¥' });
                }
                
                processed++;
                updateBulkProgress(processed, files.length, success, fail);
            }
            
            // å…¨éƒ¨å¤„ç†å®Œæˆåï¼Œä¿å­˜æ•°æ®
            await saveDataToR2();
            document.getElementById('bulkImageUploadProgress').style.display = 'none';
            
            let statusMsg = `æ‰¹é‡ä¸Šä¼ å®Œæˆï¼š${success} æˆåŠŸï¼Œ${fail} å¤±è´¥`;
            
            if (failedFiles.length > 0) {
                // æ˜¾ç¤ºå‰5ä¸ªå¤±è´¥çš„æ–‡ä»¶
                const failedList = failedFiles.slice(0, 5).map(f => `${f.name} (${f.error})`).join('; ');
                statusMsg += `ã€‚å¤±è´¥æ–‡ä»¶ï¼š${failedList}${failedFiles.length > 5 ? '...' : ''}`;
            }
            
            showStatus(statusMsg, fail > 0 ? 'error' : 'success', 'manageFormStatus');
            renderManageProducts();
            checkStorageStatus();
            e.target.value = '';
        });
        
        function updateBulkProgress(processed, total, success, fail) {
            const progress = Math.round(processed / total * 100);
            document.getElementById('bulkImageUploadProgressFill').style.width = progress + '%';
            showStatus(`æ‰¹é‡ä¸Šä¼ è¿›åº¦: ${progress}% (æˆåŠŸ: ${success}, å¤±è´¥: ${fail})`, 'loading', 'manageFormStatus');
        }

        // ============== æ•°æ®å­˜å‚¨åŠŸèƒ½ ==============
        async function saveDataToR2() {
            if (!s3Client) {
                console.warn('R2æœªé…ç½®ï¼Œæ— æ³•ä¿å­˜æ•°æ®åˆ°äº‘ç«¯');
                return;
            }
            
            const dataToSave = {
                catalogData: catalogData,
                uploadedFiles: uploadedFiles,
                searchHistory: searchHistory,
                saveTime: new Date().toISOString(),
                version: '4.0-r2'
            };
            
            const dataBlob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const key = 'yudong-cloud/database.json';
            
            try {
                await s3Client.upload({
                    Bucket: r2Config.bucket,
                    Key: key,
                    Body: dataBlob,
                    ContentType: 'application/json'
                }).promise();
                
                console.log('æ•°æ®å·²ä¿å­˜åˆ°R2');
                updateStorageStats();
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®åˆ°R2å¤±è´¥:', error);
            }
        }
        
        async function loadDataFromR2() {
            if (!s3Client) {
                console.warn('R2æœªé…ç½®ï¼Œæ— æ³•ä»äº‘ç«¯åŠ è½½æ•°æ®');
                return;
            }
            
            try {
                const data = await s3Client.getObject({
                    Bucket: r2Config.bucket,
                    Key: 'yudong-cloud/database.json'
                }).promise();
                
                const dataToLoad = JSON.parse(data.Body.toString());
                catalogData = dataToLoad.catalogData || {};
                uploadedFiles = dataToLoad.uploadedFiles || [];
                searchHistory = dataToLoad.searchHistory || [];
                
                console.log('æ•°æ®å·²ä»R2åŠ è½½');
                updateStats();
                renderHistory();
                updateStorageStats();
            } catch (error) {
                console.warn('ä»R2åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®:', error);
                catalogData = {};
                uploadedFiles = [];
                searchHistory = [];
            }
        }

        // ============== PDFå¯¼å‡ºåŠŸèƒ½ ==============
        function exportQuotePDF() {
            var allResults = [];
            if (rangeResults.length > 0) {
                rangeResults.forEach(function(range) { range.matches.forEach(function(product) { allResults.push(product); }); });
            } else {
                searchResults.filter(function(r) { return r.found; }).forEach(function(r) { allResults.push(r); });
            }
            if (allResults.length === 0) {
                showStatus('æ— ç»“æœå¯å¯¼å‡º', 'error', 'dataStatusMsg');
                return;
            }
           
            showStatus('æ­£åœ¨ç”ŸæˆæŠ¥ä»·PDF...', 'loading', 'dataStatusMsg');
            
            var printContainer = document.createElement('div');
            printContainer.id = 'pdf-content';
            printContainer.style.cssText = 'position: absolute; left: -9999px; width: 250mm; font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif; background: white; padding: 15mm; line-height: 1.1;';
            document.body.appendChild(printContainer);
           
            var html = '<h1 style="text-align: center; color: var(--color-sage); font-size: 16pt; margin-bottom: 8mm; border-bottom: 2px solid var(--color-sage); padding-bottom: 4mm;">ğŸ“Š å®‡ä¸œçººç»‡æŠ¥ä»·å•</h1>';
            html += '<div style="text-align: center; color: #666; margin-bottom: 6mm; font-size: 8pt;">ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN') + ' | äº§å“æ•°é‡ï¼š' + allResults.length + ' é¡¹</div>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 4mm; page-break-inside: auto; font-size: 7pt;">';
            html += '<thead><tr style="page-break-inside: avoid; page-break-after: auto;">';
            html += '<th style="width: 6%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">åºå·</th>';
            html += '<th style="width: 14%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">äº§å“ä»£ç </th>';
            html += '<th style="width: 9%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">ç ä»·</th>';
            html += '<th style="width: 9%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">ç±³ä»·</th>';
            html += '<th style="width: 9%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">é—¨å¹…</th>';
            html += '<th style="width: 14%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">æˆåˆ†</th>';
            html += '<th style="width: 9%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">å…‹é‡</th>';
            html += '<th style="width: 20%; background-color: var(--color-sage); color: white; padding: 5pt 3pt; text-align: center; font-size: 8pt; border: 1px solid #333; font-weight: bold;">å¤‡æ³¨</th>';
            html += '</tr></thead><tbody>';
           
            allResults.forEach(function(product, index) {
                html += '<tr style="page-break-inside: avoid; page-break-after: auto; height: auto; min-height: 12pt;">';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + (index + 1) + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;"><strong>' + product.code + '</strong></td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.price + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.priceAlt + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.width + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle; word-wrap: break-word;">' + product.composition + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: center; border: 1px solid #ddd; font-size: 7pt; vertical-align: middle;">' + product.weight + '</td>';
                html += '<td style="padding: 3pt 2pt; text-align: left; border: 1px solid #ddd; font-size: 6pt; vertical-align: top; color: #d32f2f; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; line-height: 1.2; hyphens: auto; display: block;">' + (product.notes && product.notes !== '-' ? product.notes : '') + '</td>';
                html += '</tr>';
            });
           
            html += '</tbody></table>';
            html += '<div style="text-align: center; color: #999; font-size: 6pt; margin-top: 8mm; border-top: 1px solid #ddd; padding-top: 4mm;">æœ¬æŠ¥ä»·å•ç”±å®‡ä¸œçººç»‡æŠ¥ä»·ç³»ç»Ÿç”Ÿæˆ | ç³»ç»Ÿç‰ˆæœ¬ï¼šv4.0-R2</div>';
            printContainer.innerHTML = html;
           
            html2canvas(printContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: printContainer.scrollWidth,
                height: printContainer.scrollHeight,
                logging: false
            }).then(function(canvas) {
                var { jsPDF } = window.jspdf;
                var pdf = new jsPDF('l', 'mm', 'a4');
                var pdfWidth = pdf.internal.pageSize.getWidth();
                var pdfHeight = pdf.internal.pageSize.getHeight();
                var imgWidth = pdfWidth - 30;
                var pageHeight = pdfHeight - 30;
                var imgHeight = (canvas.height * imgWidth) / canvas.width;
                var heightLeft = imgHeight;
                var position = 15;
               
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 15, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
               
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 15;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 15, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
               
                pdf.save('æŠ¥ä»·å•_' + new Date().toISOString().slice(0, 10) + '.pdf');
                showStatus('âœ… PDFç”ŸæˆæˆåŠŸï¼', 'success', 'dataStatusMsg');
                document.body.removeChild(printContainer);
            }).catch(function(error) {
                console.error('PDF generation error:', error);
                showStatus('PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error', 'dataStatusMsg');
                document.body.removeChild(printContainer);
            });
        }

        // ============== åº”ç”¨åˆå§‹åŒ– ==============
        async function initApp() {
            // åˆå§‹åŒ–R2é…ç½®
            loadR2Config();
            
            // å¦‚æœR2å·²é…ç½®ï¼Œä»R2åŠ è½½æ•°æ®ï¼Œå¦åˆ™ä½¿ç”¨ç©ºæ•°æ®
            if (s3Client) {
                await loadDataFromR2();
            } else {
                catalogData = {};
                uploadedFiles = [];
                searchHistory = [];
            }
            
            renderHistory();
            updateStats();
            initPhotoSwipe();
            checkStorageStatus();
            switchTab('query');
            
            // æ·»åŠ æœç´¢è¾“å…¥äº‹ä»¶ç›‘å¬
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                var value = e.target.value.trim();
                if (value && Object.keys(catalogData).length > 0) {
                    searchTimeout = setTimeout(function() {
                        handleSearch(value);
                        renderResults();
                    }, 300);
                } else {
                    searchResults = [];
                    fuzzyMatches = [];
                    rangeResults = [];
                    renderResults();
                }
            });
            
            // æ·»åŠ æœ¬åœ°æ•°æ®åº“å¯¼å…¥äº‹ä»¶ç›‘å¬
            document.getElementById('localDbInput').addEventListener('change', function(e) {
                importDatabase(e.target.files);
                e.target.value = '';
            });
        }
        
        // å¯åŠ¨åº”ç”¨
        initApp();
    </script>
</body>
</html>